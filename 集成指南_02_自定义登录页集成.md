# è‡ªå®šä¹‰ç™»å½•é¡µé›†æˆæŒ‡å—

> æœ¬æ–‡æ¡£ä»‹ç»å¦‚ä½•åœ¨ä½ è‡ªå·±çš„åº”ç”¨ä¸­å®ç°ç™»å½•é¡µï¼ŒåŒæ—¶æ”¯æŒæœ¬åœ°ç™»å½•å’Œç¬¬ä¸‰æ–¹å¿«æ·ç™»å½•ï¼ˆGitHubã€Googleã€Giteeã€å¾®ä¿¡ç­‰ï¼‰ã€‚

## ğŸ“‹ ç›®å½•

- [æ¦‚è¿°](#æ¦‚è¿°)
- [å®ç°åŸç†](#å®ç°åŸç†)
- [é›†æˆæ­¥éª¤](#é›†æˆæ­¥éª¤)
- [å®Œæ•´ç¤ºä¾‹](#å®Œæ•´ç¤ºä¾‹)
- [é«˜çº§åŠŸèƒ½](#é«˜çº§åŠŸèƒ½)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

---

## ğŸ¯ æ¦‚è¿°

### ä»€ä¹ˆæ˜¯è‡ªå®šä¹‰ç™»å½•é¡µé›†æˆï¼Ÿ

ä¸æ ‡å‡† OIDC é›†æˆä¸åŒï¼Œè‡ªå®šä¹‰ç™»å½•é¡µé›†æˆå…è®¸ä½ åœ¨**è‡ªå·±çš„åº”ç”¨**ä¸­å®ç°ç™»å½•ç•Œé¢ï¼Œè€Œä¸æ˜¯è·³è½¬åˆ° OneID çš„ç™»å½•é¡µã€‚è¿™ç§æ–¹å¼ç‰¹åˆ«é€‚åˆï¼š

- SaaS åº”ç”¨éœ€è¦è‡ªå®šä¹‰å“ç‰Œ
- éœ€è¦å®Œå…¨æ§åˆ¶ç™»å½•ä½“éªŒ
- å¸Œæœ›ç”¨æˆ·ç•™åœ¨åº”ç”¨å†…å®Œæˆç™»å½•
- éœ€è¦åœ¨ç™»å½•é¡µæ·»åŠ è‡ªå®šä¹‰å…ƒç´ 

### ç™»å½•é¡µæ•ˆæœ

```
ä½ çš„åº”ç”¨ç™»å½•é¡µ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      æ¬¢è¿ä½¿ç”¨ Your App Logo         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç”¨æˆ·å: [_______________]          â”‚
â”‚  å¯†ç :   [_______________]          â”‚
â”‚         [      ç™»å½•      ]          â”‚
â”‚                                     â”‚
â”‚  [ å¿˜è®°å¯†ç ï¼Ÿ ]  [ è®°ä½æˆ‘ ]         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚       å¿«é€Ÿç™»å½•                      â”‚
â”‚                                     â”‚
â”‚  [ğŸ™ GitHub] [ğŸ”µ Google] [ğŸŸ  Gitee]â”‚
â”‚             [ğŸ’¬ å¾®ä¿¡]               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ[ ç«‹å³æ³¨å†Œ ]           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å¯¹æ¯”æ ‡å‡† OIDC é›†æˆ

| ç‰¹æ€§ | æ ‡å‡† OIDC | è‡ªå®šä¹‰ç™»å½•é¡µ |
|------|----------|------------|
| å¼€å‘éš¾åº¦ | â­ ç®€å• | â­â­ ä¸­ç­‰ |
| è‡ªå®šä¹‰ç¨‹åº¦ | âŒ ä½ | âœ… é«˜ |
| å“ç‰Œä¸€è‡´æ€§ | âŒ è·³è½¬åˆ° OneID | âœ… å®Œå…¨è‡ªå®šä¹‰ |
| å®‰å…¨æ€§ | âœ… æœ€é«˜ | âœ… é«˜ |
| ç»´æŠ¤æˆæœ¬ | âœ… ä½ | âš ï¸ ä¸­ |
| ç¬¬ä¸‰æ–¹ç™»å½• | âœ… æ”¯æŒ | âœ… æ”¯æŒ |

---

## ğŸ’¡ å®ç°åŸç†

### ç”¨æˆ·æµç¨‹

#### æœ¬åœ°ç™»å½•æµç¨‹

```
1. ç”¨æˆ·åœ¨ä½ çš„ç™»å½•é¡µè¾“å…¥ç”¨æˆ·åå¯†ç 
   â†“
2. å‰ç«¯è°ƒç”¨ OneID çš„ /connect/token ç«¯ç‚¹
   â†“
3. OneID éªŒè¯å‡­æ®ï¼Œè¿”å› Access Token å’Œ ID Token
   â†“
4. å‰ç«¯ä¿å­˜ Tokenï¼Œè·³è½¬åˆ°åº”ç”¨é¦–é¡µ
   â†“
5. ç™»å½•æˆåŠŸï¼
```

#### ç¬¬ä¸‰æ–¹å¿«æ·ç™»å½•æµç¨‹

```
1. ç”¨æˆ·ç‚¹å‡»"GitHub ç™»å½•"æŒ‰é’®
   â†“
2. å‰ç«¯ç›´æ¥è·³è½¬åˆ° OneID çš„å¤–éƒ¨ç™»å½•ç«¯ç‚¹
   (ç»•è¿‡ OneID ç™»å½•é¡µï¼Œç›´æ¥åˆ° GitHub)
   â†“
3. ç”¨æˆ·åœ¨ GitHub å®Œæˆæˆæƒ
   â†“
4. GitHub å›è°ƒåˆ° OneID
   â†“
5. OneID åˆ›å»º/ç»‘å®šç”¨æˆ·è´¦å·
   â†“
6. OneID å›è°ƒåˆ°ä½ çš„åº”ç”¨ï¼ˆæºå¸¦æˆæƒç ï¼‰
   â†“
7. ä½ çš„åº”ç”¨ç”¨æˆæƒç æ¢å– Token
   â†“
8. ç™»å½•æˆåŠŸï¼
```

### å…³é”® API ç«¯ç‚¹

| ç«¯ç‚¹ | è¯´æ˜ | ç”¨é€” |
|------|------|------|
| `POST /connect/token` | è·å– Token | ç”¨æˆ·åå¯†ç ç™»å½• |
| `GET /api/externalauth/providers` | è·å–æä¾›å•†åˆ—è¡¨ | æ˜¾ç¤ºç¬¬ä¸‰æ–¹ç™»å½•æŒ‰é’® |
| `GET /api/externalauth/challenge/{provider}` | å‘èµ·å¤–éƒ¨ç™»å½• | ç¬¬ä¸‰æ–¹å¿«æ·ç™»å½• |
| `POST /connect/token` (refresh) | åˆ·æ–° Token | Token ç»­æœŸ |

---

## ğŸš€ é›†æˆæ­¥éª¤

### æ­¥éª¤ 1: è·å–å¯ç”¨çš„ç¬¬ä¸‰æ–¹ç™»å½•æä¾›å•†

```typescript
// src/lib/authApi.ts

export interface ExternalProvider {
  name: string;
  displayName: string;
}

export async function getExternalProviders(): Promise<ExternalProvider[]> {
  try {
    const response = await fetch('http://localhost:5001/api/externalauth/providers');
    
    if (!response.ok) {
      throw new Error('Failed to load external providers');
    }
    
    const providers = await response.json();
    return providers;
  } catch (error) {
    console.error('Error loading external providers:', error);
    return [];
  }
}
```

---

### æ­¥éª¤ 2: å®ç°æœ¬åœ°ç™»å½•

```typescript
// src/lib/authApi.ts

export interface LoginCredentials {
  username: string;
  password: string;
}

export interface TokenResponse {
  access_token: string;
  id_token: string;
  token_type: string;
  expires_in: number;
  refresh_token?: string;
  scope: string;
}

export async function loginWithPassword(
  credentials: LoginCredentials
): Promise<TokenResponse> {
  const params = new URLSearchParams();
  params.append('grant_type', 'password');
  params.append('username', credentials.username);
  params.append('password', credentials.password);
  params.append('client_id', 'your-client-id');
  params.append('client_secret', 'your-client-secret'); // ä»…æœåŠ¡ç«¯åº”ç”¨éœ€è¦
  params.append('scope', 'openid profile email');

  const response = await fetch('http://localhost:5001/connect/token', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
    },
    body: params.toString(),
  });

  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.error_description || 'ç™»å½•å¤±è´¥');
  }

  const tokenResponse: TokenResponse = await response.json();
  
  // ä¿å­˜ Token
  localStorage.setItem('access_token', tokenResponse.access_token);
  localStorage.setItem('id_token', tokenResponse.id_token);
  if (tokenResponse.refresh_token) {
    localStorage.setItem('refresh_token', tokenResponse.refresh_token);
  }
  
  // è®¡ç®—è¿‡æœŸæ—¶é—´
  const expiresAt = Date.now() + tokenResponse.expires_in * 1000;
  localStorage.setItem('expires_at', expiresAt.toString());
  
  return tokenResponse;
}
```

---

### æ­¥éª¤ 3: å®ç°ç¬¬ä¸‰æ–¹å¿«æ·ç™»å½•

```typescript
// src/lib/authApi.ts

export function loginWithProvider(providerName: string, returnUrl?: string) {
  // ä¿å­˜å½“å‰è·¯å¾„ï¼Œç¨åè¿”å›
  if (returnUrl) {
    sessionStorage.setItem('post_login_redirect', returnUrl);
  }
  
  // æ„é€ å›è°ƒ URL
  const callbackUrl = `${window.location.origin}/auth/callback`;
  
  // è·³è½¬åˆ° OneID çš„å¤–éƒ¨ç™»å½•ç«¯ç‚¹
  // OneID ä¼šç›´æ¥é‡å®šå‘åˆ°ç¬¬ä¸‰æ–¹ï¼ˆä¾‹å¦‚ GitHubï¼‰
  window.location.href = 
    `http://localhost:5001/api/externalauth/challenge/${providerName}?returnUrl=${encodeURIComponent(callbackUrl)}`;
}
```

---

### æ­¥éª¤ 4: å¤„ç†ç¬¬ä¸‰æ–¹ç™»å½•å›è°ƒ

```typescript
// src/pages/AuthCallbackPage.tsx

import React, { useEffect, useState } from 'react';
import { useNavigate, useSearchParams } from 'react-router-dom';

export function AuthCallbackPage() {
  const navigate = useNavigate();
  const [searchParams] = useSearchParams();
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    const handleCallback = async () => {
      // æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯
      const errorParam = searchParams.get('error');
      if (errorParam) {
        setError(searchParams.get('error_description') || errorParam);
        return;
      }

      // è·å–æˆæƒç 
      const code = searchParams.get('code');
      if (!code) {
        setError('æœªæ”¶åˆ°æˆæƒç ');
        return;
      }

      try {
        // ç”¨æˆæƒç æ¢å– Token
        await exchangeCodeForToken(code);
        
        // è·³è½¬åˆ°ä¹‹å‰çš„é¡µé¢
        const redirectUrl = sessionStorage.getItem('post_login_redirect') || '/';
        sessionStorage.removeItem('post_login_redirect');
        navigate(redirectUrl);
      } catch (err: any) {
        setError(err.message);
      }
    };

    handleCallback();
  }, [searchParams, navigate]);

  if (error) {
    return (
      <div className="error-page">
        <h2>ç™»å½•å¤±è´¥</h2>
        <p>{error}</p>
        <button onClick={() => navigate('/login')}>è¿”å›ç™»å½•</button>
      </div>
    );
  }

  return (
    <div className="loading-page">
      <p>æ­£åœ¨å¤„ç†ç™»å½•ï¼Œè¯·ç¨å€™...</p>
    </div>
  );
}

// ç”¨æˆæƒç æ¢å– Token
async function exchangeCodeForToken(code: string): Promise<void> {
  const params = new URLSearchParams();
  params.append('grant_type', 'authorization_code');
  params.append('code', code);
  params.append('client_id', 'your-client-id');
  params.append('client_secret', 'your-client-secret'); // ä»…æœåŠ¡ç«¯åº”ç”¨
  params.append('redirect_uri', `${window.location.origin}/auth/callback`);

  const response = await fetch('http://localhost:5001/connect/token', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
    },
    body: params.toString(),
  });

  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.error_description || 'è·å– Token å¤±è´¥');
  }

  const tokenResponse = await response.json();
  
  // ä¿å­˜ Token
  localStorage.setItem('access_token', tokenResponse.access_token);
  localStorage.setItem('id_token', tokenResponse.id_token);
  if (tokenResponse.refresh_token) {
    localStorage.setItem('refresh_token', tokenResponse.refresh_token);
  }
  
  const expiresAt = Date.now() + tokenResponse.expires_in * 1000;
  localStorage.setItem('expires_at', expiresAt.toString());
}
```

---

### æ­¥éª¤ 5: å®ç°ç™»å‡º

```typescript
// src/lib/authApi.ts

export function logout() {
  // æ¸…é™¤æœ¬åœ° Token
  localStorage.removeItem('access_token');
  localStorage.removeItem('id_token');
  localStorage.removeItem('refresh_token');
  localStorage.removeItem('expires_at');
  
  // å¯é€‰ï¼šè°ƒç”¨ OneID çš„ç™»å‡ºç«¯ç‚¹ï¼ˆå…¨å±€ç™»å‡ºï¼‰
  // window.location.href = 'http://localhost:5001/connect/endsession';
  
  // è·³è½¬åˆ°ç™»å½•é¡µ
  window.location.href = '/login';
}
```

---

### æ­¥éª¤ 6: åˆ·æ–° Token

```typescript
// src/lib/authApi.ts

export async function refreshAccessToken(): Promise<TokenResponse> {
  const refreshToken = localStorage.getItem('refresh_token');
  
  if (!refreshToken) {
    throw new Error('No refresh token available');
  }

  const params = new URLSearchParams();
  params.append('grant_type', 'refresh_token');
  params.append('refresh_token', refreshToken);
  params.append('client_id', 'your-client-id');
  params.append('client_secret', 'your-client-secret');

  const response = await fetch('http://localhost:5001/connect/token', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
    },
    body: params.toString(),
  });

  if (!response.ok) {
    // Refresh token å¤±æ•ˆï¼Œéœ€è¦é‡æ–°ç™»å½•
    logout();
    throw new Error('Refresh token expired');
  }

  const tokenResponse: TokenResponse = await response.json();
  
  // æ›´æ–° Token
  localStorage.setItem('access_token', tokenResponse.access_token);
  const expiresAt = Date.now() + tokenResponse.expires_in * 1000;
  localStorage.setItem('expires_at', expiresAt.toString());
  
  return tokenResponse;
}

// æ£€æŸ¥ Token æ˜¯å¦å³å°†è¿‡æœŸï¼Œè‡ªåŠ¨åˆ·æ–°
export async function ensureValidToken(): Promise<string> {
  const accessToken = localStorage.getItem('access_token');
  const expiresAt = localStorage.getItem('expires_at');
  
  if (!accessToken || !expiresAt) {
    throw new Error('Not logged in');
  }
  
  // å¦‚æœ Token åœ¨ 5 åˆ†é’Ÿå†…è¿‡æœŸï¼Œåˆ·æ–°å®ƒ
  if (Date.now() > parseInt(expiresAt) - 5 * 60 * 1000) {
    console.log('Token expiring soon, refreshing...');
    const tokenResponse = await refreshAccessToken();
    return tokenResponse.access_token;
  }
  
  return accessToken;
}
```

---

## ğŸ’» å®Œæ•´ç¤ºä¾‹

### ç™»å½•é¡µé¢ç»„ä»¶

```typescript
// src/pages/LoginPage.tsx

import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { 
  loginWithPassword, 
  loginWithProvider, 
  getExternalProviders,
  type ExternalProvider 
} from '../lib/authApi';

export function LoginPage() {
  const navigate = useNavigate();
  const [username, setUsername] = useState('');
  const [password, setPassword] = useState('');
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');
  const [providers, setProviders] = useState<ExternalProvider[]>([]);

  // åŠ è½½å¤–éƒ¨ç™»å½•æä¾›å•†
  useEffect(() => {
    const loadProviders = async () => {
      const list = await getExternalProviders();
      setProviders(list);
    };
    loadProviders();
  }, []);

  // æœ¬åœ°ç™»å½•
  const handleLocalLogin = async (e: React.FormEvent) => {
    e.preventDefault();
    setError('');
    setLoading(true);

    try {
      await loginWithPassword({ username, password });
      navigate('/dashboard'); // ç™»å½•æˆåŠŸï¼Œè·³è½¬åˆ°é¦–é¡µ
    } catch (err: any) {
      setError(err.message);
    } finally {
      setLoading(false);
    }
  };

  // ç¬¬ä¸‰æ–¹ç™»å½•
  const handleExternalLogin = (providerName: string) => {
    loginWithProvider(providerName, '/dashboard');
  };

  // å›¾æ ‡ç»„ä»¶
  const getProviderIcon = (name: string) => {
    switch (name.toLowerCase()) {
      case 'github':
        return 'ğŸ™';
      case 'google':
        return 'ğŸ”µ';
      case 'gitee':
        return 'ğŸŸ ';
      case 'wechat':
        return 'ğŸ’¬';
      default:
        return 'ğŸ”‘';
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50">
      <div className="max-w-md w-full space-y-8 p-8 bg-white rounded-lg shadow-md">
        {/* æ ‡é¢˜ */}
        <div className="text-center">
          <h2 className="text-3xl font-bold text-gray-900">æ¬¢è¿å›æ¥</h2>
          <p className="mt-2 text-sm text-gray-600">ç™»å½•åˆ°æ‚¨çš„è´¦å·</p>
        </div>

        {/* é”™è¯¯æç¤º */}
        {error && (
          <div className="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded">
            {error}
          </div>
        )}

        {/* æœ¬åœ°ç™»å½•è¡¨å• */}
        <form onSubmit={handleLocalLogin} className="mt-8 space-y-6">
          <div>
            <label htmlFor="username" className="block text-sm font-medium text-gray-700">
              ç”¨æˆ·åæˆ–é‚®ç®±
            </label>
            <input
              id="username"
              type="text"
              required
              value={username}
              onChange={(e) => setUsername(e.target.value)}
              className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              placeholder="è¯·è¾“å…¥ç”¨æˆ·åæˆ–é‚®ç®±"
            />
          </div>

          <div>
            <label htmlFor="password" className="block text-sm font-medium text-gray-700">
              å¯†ç 
            </label>
            <input
              id="password"
              type="password"
              required
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              placeholder="è¯·è¾“å…¥å¯†ç "
            />
          </div>

          <div className="flex items-center justify-between">
            <div className="flex items-center">
              <input
                id="remember-me"
                type="checkbox"
                className="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
              />
              <label htmlFor="remember-me" className="ml-2 block text-sm text-gray-900">
                è®°ä½æˆ‘
              </label>
            </div>

            <div className="text-sm">
              <a href="/forgot-password" className="font-medium text-blue-600 hover:text-blue-500">
                å¿˜è®°å¯†ç ï¼Ÿ
              </a>
            </div>
          </div>

          <button
            type="submit"
            disabled={loading}
            className="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50"
          >
            {loading ? 'ç™»å½•ä¸­...' : 'ç™»å½•'}
          </button>
        </form>

        {/* ç¬¬ä¸‰æ–¹å¿«æ·ç™»å½• */}
        {providers.length > 0 && (
          <>
            <div className="relative">
              <div className="absolute inset-0 flex items-center">
                <div className="w-full border-t border-gray-300"></div>
              </div>
              <div className="relative flex justify-center text-sm">
                <span className="px-2 bg-white text-gray-500">æˆ–è€…å¿«é€Ÿç™»å½•</span>
              </div>
            </div>

            <div className="grid grid-cols-2 gap-3">
              {providers.map((provider) => (
                <button
                  key={provider.name}
                  onClick={() => handleExternalLogin(provider.name)}
                  className="flex items-center justify-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                >
                  <span className="text-xl mr-2">{getProviderIcon(provider.name)}</span>
                  {provider.displayName}
                </button>
              ))}
            </div>
          </>
        )}

        {/* æ³¨å†Œé“¾æ¥ */}
        <div className="text-center text-sm">
          <span className="text-gray-600">è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ</span>
          <a href="/register" className="ml-1 font-medium text-blue-600 hover:text-blue-500">
            ç«‹å³æ³¨å†Œ
          </a>
        </div>
      </div>
    </div>
  );
}
```

---

## ğŸ¨ é«˜çº§åŠŸèƒ½

### 1. ç¤¾äº¤è´¦å·ç»‘å®š

å…è®¸ç”¨æˆ·å°†ç¬¬ä¸‰æ–¹è´¦å·ç»‘å®šåˆ°ç°æœ‰è´¦å·ï¼š

```typescript
// src/pages/ProfilePage.tsx

export function ProfilePage() {
  const [linkedAccounts, setLinkedAccounts] = useState<string[]>([]);
  const [providers, setProviders] = useState<ExternalProvider[]>([]);

  useEffect(() => {
    loadLinkedAccounts();
    loadProviders();
  }, []);

  const handleBindAccount = (providerName: string) => {
    // è·³è½¬åˆ°ç»‘å®šæµç¨‹
    loginWithProvider(providerName, '/profile?action=bind');
  };

  const handleUnbindAccount = async (providerName: string) => {
    try {
      const token = await ensureValidToken();
      const response = await fetch(
        `http://localhost:5002/api/users/me/external-logins/${providerName}`,
        {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`,
          },
        }
      );
      
      if (response.ok) {
        alert('è§£ç»‘æˆåŠŸ');
        loadLinkedAccounts();
      }
    } catch (error) {
      console.error('è§£ç»‘å¤±è´¥:', error);
    }
  };

  return (
    <div className="profile-page">
      <h2>è´¦å·ç»‘å®š</h2>
      <div className="linked-accounts">
        {providers.map(provider => {
          const isLinked = linkedAccounts.includes(provider.name);
          return (
            <div key={provider.name} className="account-item">
              <span>{provider.displayName}</span>
              {isLinked ? (
                <button onClick={() => handleUnbindAccount(provider.name)}>
                  è§£ç»‘
                </button>
              ) : (
                <button onClick={() => handleBindAccount(provider.name)}>
                  ç»‘å®š
                </button>
              )}
            </div>
          );
        })}
      </div>
    </div>
  );
}
```

### 2. è‡ªåŠ¨ Token åˆ·æ–°

```typescript
// src/lib/tokenRefresh.ts

let refreshTimer: NodeJS.Timeout | null = null;

export function startTokenRefreshTimer() {
  // æ¸…é™¤å·²æœ‰çš„å®šæ—¶å™¨
  if (refreshTimer) {
    clearTimeout(refreshTimer);
  }

  const expiresAt = localStorage.getItem('expires_at');
  if (!expiresAt) return;

  const expiresIn = parseInt(expiresAt) - Date.now();
  
  // åœ¨è¿‡æœŸå‰ 5 åˆ†é’Ÿåˆ·æ–°
  const refreshIn = expiresIn - 5 * 60 * 1000;
  
  if (refreshIn > 0) {
    refreshTimer = setTimeout(async () => {
      try {
        await refreshAccessToken();
        console.log('Token åˆ·æ–°æˆåŠŸ');
        startTokenRefreshTimer(); // é‡æ–°å¯åŠ¨å®šæ—¶å™¨
      } catch (error) {
        console.error('Token åˆ·æ–°å¤±è´¥:', error);
      }
    }, refreshIn);
  }
}

// åœ¨åº”ç”¨å¯åŠ¨æ—¶è°ƒç”¨
// src/App.tsx
import { startTokenRefreshTimer } from './lib/tokenRefresh';

function App() {
  useEffect(() => {
    startTokenRefreshTimer();
  }, []);
  
  // ...
}
```

### 3. å¯†ç å¼ºåº¦éªŒè¯

```typescript
// src/components/PasswordInput.tsx

import React, { useState } from 'react';

interface PasswordStrength {
  score: number; // 0-4
  feedback: string;
}

function checkPasswordStrength(password: string): PasswordStrength {
  let score = 0;
  const feedback: string[] = [];

  // é•¿åº¦æ£€æŸ¥
  if (password.length >= 8) score++;
  else feedback.push('è‡³å°‘8ä¸ªå­—ç¬¦');

  // åŒ…å«å¤§å†™å­—æ¯
  if (/[A-Z]/.test(password)) score++;
  else feedback.push('åŒ…å«å¤§å†™å­—æ¯');

  // åŒ…å«å°å†™å­—æ¯
  if (/[a-z]/.test(password)) score++;
  else feedback.push('åŒ…å«å°å†™å­—æ¯');

  // åŒ…å«æ•°å­—
  if (/\d/.test(password)) score++;
  else feedback.push('åŒ…å«æ•°å­—');

  // åŒ…å«ç‰¹æ®Šå­—ç¬¦
  if (/[^A-Za-z0-9]/.test(password)) score++;

  return {
    score,
    feedback: feedback.join(', ') || 'å¯†ç å¼ºåº¦å¾ˆå¥½',
  };
}

export function PasswordInput({ value, onChange }: any) {
  const strength = checkPasswordStrength(value);
  const colors = ['bg-red-500', 'bg-orange-500', 'bg-yellow-500', 'bg-blue-500', 'bg-green-500'];

  return (
    <div>
      <input
        type="password"
        value={value}
        onChange={onChange}
        className="w-full px-3 py-2 border rounded"
      />
      
      {/* å¯†ç å¼ºåº¦æŒ‡ç¤ºå™¨ */}
      <div className="mt-2">
        <div className="flex space-x-1">
          {[...Array(5)].map((_, i) => (
            <div
              key={i}
              className={`h-2 flex-1 rounded ${
                i < strength.score ? colors[strength.score] : 'bg-gray-200'
              }`}
            />
          ))}
        </div>
        <p className="text-sm text-gray-600 mt-1">{strength.feedback}</p>
      </div>
    </div>
  );
}
```

---

## âœ… æœ€ä½³å®è·µ

### 1. å®‰å…¨æ€§

- âœ… ä½¿ç”¨ HTTPSï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
- âœ… ä¸è¦åœ¨å‰ç«¯æš´éœ² Client Secret
- âœ… ä½¿ç”¨ HttpOnly Cookie å­˜å‚¨ Refresh Token
- âœ… å®ç° CSRF ä¿æŠ¤
- âœ… è®¾ç½®åˆç†çš„ Token è¿‡æœŸæ—¶é—´

### 2. ç”¨æˆ·ä½“éªŒ

- âœ… æä¾›æ¸…æ™°çš„é”™è¯¯æç¤º
- âœ… åŠ è½½çŠ¶æ€åé¦ˆ
- âœ… è®°ä½ç”¨æˆ·é€‰æ‹©çš„ç™»å½•æ–¹å¼
- âœ… æ”¯æŒ"è®°ä½æˆ‘"åŠŸèƒ½
- âœ… è‡ªåŠ¨ Token åˆ·æ–°

### 3. æ€§èƒ½ä¼˜åŒ–

- âœ… ç¼“å­˜å¤–éƒ¨æä¾›å•†åˆ—è¡¨
- âœ… é˜²æŠ–è¡¨å•æäº¤
- âœ… æ‡’åŠ è½½ç¬¬ä¸‰æ–¹ SDK

### 4. å¯è®¿é—®æ€§

- âœ… ä½¿ç”¨è¯­ä¹‰åŒ– HTML
- âœ… æ·»åŠ  ARIA æ ‡ç­¾
- âœ… æ”¯æŒé”®ç›˜å¯¼èˆª
- âœ… æä¾›å±å¹•é˜…è¯»å™¨æ”¯æŒ

---

## ğŸ”§ æ•…éšœæ’é™¤

### é—®é¢˜ 1: Resource Owner Password è¢«ç¦ç”¨

**é”™è¯¯**ï¼š`unsupported_grant_type`

**åŸå› **ï¼šOneID é»˜è®¤ä¸å¯ç”¨ Resource Owner Password Credentials æµç¨‹ï¼ˆä¸å®‰å…¨ï¼‰

**è§£å†³**ï¼š

1. åœ¨ OneID Admin Portal ä¸­å¯ç”¨å®¢æˆ·ç«¯çš„ Password æˆæƒç±»å‹
2. æˆ–è€…æ”¹ç”¨æ ‡å‡† OIDC æµç¨‹ï¼ˆæ¨èï¼‰

### é—®é¢˜ 2: è·¨åŸŸé—®é¢˜

**é”™è¯¯**ï¼š`CORS policy: No 'Access-Control-Allow-Origin' header`

**è§£å†³**ï¼šé…ç½® OneID çš„ CORSï¼š

```csharp
// OneID.Identity/Program.cs
builder.Services.AddCors(options =>
{
    options.AddDefaultPolicy(policy =>
    {
        policy.WithOrigins("http://localhost:3000")
              .AllowAnyHeader()
              .AllowAnyMethod()
              .AllowCredentials();
    });
});
```

### é—®é¢˜ 3: Token å­˜å‚¨å®‰å…¨æ€§

**é—®é¢˜**ï¼šAccess Token å­˜å‚¨åœ¨ localStorageï¼Œå®¹æ˜“è¢« XSS æ”»å‡»

**å»ºè®®æ–¹æ¡ˆ**ï¼š

1. ä½¿ç”¨ HttpOnly Cookieï¼ˆéœ€è¦åç«¯é…åˆï¼‰
2. ä½¿ç”¨å†…å­˜å­˜å‚¨ + Session Storage
3. å®æ–½ä¸¥æ ¼çš„ CSP ç­–ç•¥

---

## ğŸ“š ç›¸å…³èµ„æº

- [æ ‡å‡† OIDC é›†æˆ](./é›†æˆæŒ‡å—_01_æ ‡å‡†OIDCé›†æˆ.md)
- [è´¦å·ç»Ÿä¸€ç®¡ç†](./é›†æˆæŒ‡å—_03_è´¦å·ç»Ÿä¸€ç®¡ç†.md)
- [OAuth 2.0 è§„èŒƒ](https://oauth.net/2/)
- [OWASP å®‰å…¨æŒ‡å—](https://owasp.org/)

---

## ğŸ¯ æ€»ç»“

**è‡ªå®šä¹‰ç™»å½•é¡µé›†æˆé€‚åˆ**ï¼š

- âœ… SaaS åº”ç”¨
- âœ… éœ€è¦å®Œå…¨è‡ªå®šä¹‰ UI/UX
- âœ… å¸Œæœ›ç”¨æˆ·ç•™åœ¨åº”ç”¨å†…
- âœ… æœ‰å‰ç«¯å¼€å‘èƒ½åŠ›

**å¦‚æœä½ åªéœ€è¦ç®€å•çš„é›†æˆï¼Œæ¨èä½¿ç”¨** [æ ‡å‡† OIDC é›†æˆ](./é›†æˆæŒ‡å—_01_æ ‡å‡†OIDCé›†æˆ.md)ã€‚

Happy Coding! ğŸš€

