# PRD｜统一身份认证平台（OneID）
版本：v0.1 · 日期：2025-10-05

## 1. 背景与目标
- 各业务系统分散维护用户与登录逻辑，成本高且不一致。
- 希望提供**统一的认证与授权**入口，支持**外部平台登录**与**多数据库**，并对其他系统提供**标准化跳转认证**能力。
- 目标：在 8–12 周内交付可上线的 **MVP**，并具备迭代空间。

## 2. 范围（In Scope）
- **身份提供者（IdP）**：提供 OIDC（OAuth 2.1 授权码 + PKCE）能力。
- **账号体系**：本地账号 + 外部账号绑定（GitHub/Gitee/Google/微信）。
- **多租户**（MVP：单租户内多应用；后续：Host/Path/Header/Claim 映射的多租户）。
- **安全能力**：MFA（TOTP、WebAuthn/Passkey）、会话管理、审计日志、风控基线（限流/黑白名单）。
- **管理后台**：客户端、作用域、用户、角色/权限、租户、策略等管理。
- **多数据库支持**：PostgreSQL / SQL Server / MySQL / SQLite 任选一种或切换。

不包含：
- 完整 IAM（RBAC/ABAC）到业务系统细粒度授权（本平台提供**令牌与标准 Claim**，策略由业务侧落地）。
- 企业微信/钉钉/飞书等企业生态（可规划为后续增量）。

## 3. 用户与角色
- **终端用户（User）**：使用邮箱/手机号或外部平台登录。
- **租户管理员（Tenant Admin）**：管理本租户内的客户端、用户、策略。
- **平台管理员（Platform Admin）**：全局配置、审计、安全策略、密钥轮换。

## 4. 核心用户故事（精选）
- 作为用户，我希望用 GitHub/微信扫码登录，首次自动创建账号并提示绑定手机号。  
- 作为租户管理员，我能创建一个 OIDC 客户端，配置回调地址和允许的作用域，拿到 `client_id`/`client_secret`。  
- 作为业务系统，我希望通过 **授权码 + PKCE** 跳转获取 ID Token/JWT Access Token，并能从平台拉 `userinfo`。  
- 作为平台管理员，我能启用 **强制 MFA**、设置密码策略、查看审计日志与告警。

## 5. 功能清单
### 5.1 认证
- 本地登录：用户名/邮箱/手机号 + 密码；密码找回与重置。
- 外部登录：GitHub/Gitee/Google/微信；支持多外部账号绑定到同一用户。
- MFA：TOTP（如基于 RFC6238）、WebAuthn/Passkey（安全密钥/平台密钥）。
- 会话：单点登录、前/后通道注销、会话查看与手动失效。

### 5.2 授权（OIDC）
- 授权码 + PKCE、刷新令牌轮换、短期 Access Token、长寿命 Refresh Token（可配置）。
- 作用域（`openid profile email phone offline_access` + 自定义）、标准与自定义 Claim。
- 发现文档 `/.well-known/openid-configuration`、JWKs `/.well-known/jwks.json`。

### 5.3 管理能力
- 客户端管理：Grant Types、重定向 URI、CORS、作用域、Token 生命周期策略。
- 用户与组织（可选）：用户、组织、角色（基础 RBAC）、外部绑定、凭据与 MFA。  
- 租户管理：租户配置、域名映射、主题定制、登录策略。  
- 审计与可观测：登录/授权/敏感操作审计，OpenTelemetry 指标、日志与追踪。

## 6. 非功能需求（NFR）
- **可用性**：99.9%（单可用区）；支持水平扩展（无粘性 Session，使用分布式缓存）。
- **性能**：
  - 授权端到端 P95 < 400ms（缓存命中）；
  - 并发 1k RPS 下稳定（通过扩容达到）。
- **安全**：OWASP ASVS L2 基线；密钥硬件/托管保管；最小权限访问；密钥与令牌轮换。
- **可观测**：核心指标（授权成功率、失败率、延迟、外部登录成功率、错误类型占比）。
- **合规**：GDPR/PIPL 最小化收集；可导出/删除用户数据；日志脱敏。

## 7. 里程碑（示例）
- M1（第 2 周）：基础骨架、数据库迁移、用户/登录页原型。  
- M2（第 4 周）：本地账号登录、OIDC 最小闭环（授权码 + PKCE、`userinfo`）。  
- M3（第 6 周）：GitHub/Gitee/Google/微信接入；管理台：客户端与作用域。  
- M4（第 8 周）：MFA、审计日志、监控告警、Docker 化上线试运行。  
- M5（第 12 周）：多租户、主题化、合规模块与安全加固。

## 8. 成功指标（KPI）
- 接入应用数 ≥ 5；外部登录占比 ≥ 30%；MFA 启用率 ≥ 40%。
- 登录成功率 ≥ 99%；授权失败率 < 0.5%；平均登录耗时 < 2s。

## 9. 风险与缓解
- 外部平台策略变化 ⇒ 封装**适配层** + 版本化配置；回退到本地登录。
- OIDC 客户端误配 ⇒ 管控台校验、Lint/测试、灰度发布。
- 秘钥泄露 ⇒ 密钥托管 + 定期轮换 + JWK kid 版本化 + 审计告警。
