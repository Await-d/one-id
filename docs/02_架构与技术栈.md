# 架构与技术栈

## 1. 总体架构
```
[Browser / App] --(OIDC Auth Code + PKCE)--> [OneID Identity Server]
      |                                        |-- EF Core --> [DB: PostgreSQL/SQLServer/MySQL/SQLite]
      |                                        |-- Cache --> [Redis]
      |                                        |-- Telemetry --> [OTel Collector -> Prometheus/Grafana/Jaeger]
      |                                        |-- Webhooks/Audit -> [MQ/RabbitMQ] (可选)
[Business RP] <----------- JWT / Introspect ---------^
```

- **OneID Identity Server**：ASP.NET Core + OpenIddict 实现 OIDC Provider；集成 ASP.NET Core Identity 做本地账号与外部绑定。  
- **管理后台（React 19 SPA）**：对客户端/用户/租户/策略进行管理。  
- **多数据库**：通过 EF Core 提供多 Provider，配置化切换。  
- **无状态伸缩**：会话以 Cookie（同站）+ 分布式票据/缓存实现；Access Token 为 JWT；可选 Reference Token + Introspection。

## 2. 技术栈清单
### 后端（.NET 9 / C# 12+）
- **Web 框架**：ASP.NET Core Minimal API / MVC
- **身份与协议**：ASP.NET Core Identity + **OpenIddict**（OIDC Provider）
- **数据访问**：Entity Framework Core（PostgreSQL / SQL Server / MySQL / SQLite Provider）
- **验证/消息**：FluentValidation、MediatR（应用层解耦）
- **日志/追踪**：Serilog、OpenTelemetry（Logs/Traces/Metrics）
- **缓存**：Redis（StackExchange.Redis）
- **文档**：Swagger（Swashbuckle）
- **安全**：Data Protection、Key Rotation、Rate Limiting、中间件安全基线（CORS/CSRF/Headers）

### 前端（React 19 / TypeScript）
- **构建**：Vite
- **状态**：Zustand 或 Redux Toolkit（两者选一）
- **数据请求**：@tanstack/react-query + Axios
- **路由**：React Router / TanStack Router
- **UI**：Ant Design / MUI（二选一）
- **认证**：oidc-client-ts（授权码 + PKCE）
- **测试**：Vitest + Testing Library + Playwright（E2E）
- **代码质量**：ESLint + Prettier + Husky + lint-staged

### 运维
- **容器**：Docker / containerd
- **编排**：Kubernetes（Helm Charts 可选）
- **反向代理**：Nginx / Ingress-Nginx
- **证书**：Let's Encrypt / ACME
- **配置与密钥**：环境变量 + K8s Secret（可接入 Vault / Key Vault）

## 3. 关键设计
### 3.1 OIDC 端点（OpenIddict 默认约定）
- `/.well-known/openid-configuration`（发现）
- `/.well-known/jwks.json`（JWK 集）
- `/connect/authorize`（授权）
- `/connect/token`（令牌）
- `/connect/userinfo`（用户信息）
- `/connect/introspect`（令牌内省，可选）
- `/connect/revocation`（撤销）
- `/connect/endsession`（注销）

### 3.2 令牌与安全参数（建议值，可配置）
- Access Token：**JWT**，默认 15 分钟
- ID Token：5–10 分钟
- Refresh Token：**轮换** & 30 天（滑动过期）
- 签名算法：`RS256`（可升级 `ES256/EdDSA`）；支持 **JWK 轮换**（kid）
- 授权：**授权码 + PKCE（S256）**；机机调用用 `client_credentials`（可选）

### 3.3 会话与注销
- 同站 Cookie + Session Store（Redis）；启用 `SameSite=Lax`、`HttpOnly`、`Secure`。  
- 注销：支持 **前通道** 与 **后通道**，RP 可注册 `post_logout_redirect_uri`。

### 3.4 多租户
- `TenantId` 字段贯穿核心表；通过 Host/Path/Header/Claim 解析租户；主题与登录策略可绑定至租户。

### 3.5 目录结构（示例）
```
/backend
  /OneID.Identity
    /Api        # OIDC 端点、账号、外部登录回调
    /Auth       # 策略、授权处理
    /Config     # OpenIddict/Identity/EF 配置
    /Domain     # 聚合根与领域服务（可简化）
    /Infra      # EF Core、Repo、缓存、外部平台适配层
    /Keys       # JWK/证书管理（生产不落盘，走 KMS/Vault）
    Program.cs  # 入口
  /OneID.AdminApi
    ...
/frontend
  /admin
  /login
```

## 4. 典型序列图（文字）
- **授权码 + PKCE**：
  1) SPA 重定向至 `/connect/authorize?client_id=...&code_challenge=...`  
  2) 用户在 OneID 登录/MFA/同意  
  3) 回调 `redirect_uri?code=...&state=...`  
  4) SPA 以 `code_verifier` 向 `/connect/token` 换取 `id_token`/`access_token`/`refresh_token`  
  5) 携带 Bearer Token 访问 RP API；必要时调用 `userinfo`。

## 5. 可扩展点
- SAML 2.0（Sustainsys.Saml2 插件）
- 企业登录（企业微信/钉钉/飞书）
- 设备授权（/connect/deviceauthorization）
- 风控（IP/设备指纹/风控评分）
