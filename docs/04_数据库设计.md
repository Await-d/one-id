# 数据库设计

> 采用 **EF Core** Code-First，多数据库 Provider。推荐 ID 类型使用 **ULID** 或 GUID（顺序化）。

## 1. 核心实体（表）
### 1.1 用户与凭据
- `Users`
  - `Id` (pk)
  - `UserName`, `NormalizedUserName`
  - `Email`, `NormalizedEmail`, `EmailConfirmed`
  - `PhoneNumber`, `PhoneNumberConfirmed`
  - `PasswordHash`, `SecurityStamp`, `ConcurrencyStamp`
  - `TwoFactorEnabled`, `LockoutEnd`, `AccessFailedCount`
  - `TenantId` (nullable), `CreatedAt`, `UpdatedAt`, `DeletedAt` (soft delete)
- `UserClaims`（标准 ASP.NET Identity 表）
- `UserLogins`（外部登录绑定：`LoginProvider`, `ProviderKey`, `ProviderDisplayName`）
- `UserTokens`（RememberMe、恢复码等）
- `WebAuthnCredentials`（Passkey 公钥、Sign Counter、CredId、AAGUID）
- `UserMfaTotp`（密钥、恢复码、上次验证）

### 1.2 OIDC 配置
- `Clients`
  - `ClientId` (唯一)
  - `ClientSecretHash`（哈希存储）
  - `DisplayName`, `LogoUri`
  - `GrantTypes`（CSV/JSON）
  - `RedirectUris`（JSON）
  - `PostLogoutRedirectUris`（JSON）
  - `AllowedScopes`（JSON）
  - `AllowedCorsOrigins`（JSON）
  - `RequirePkce`, `RequireConsent`
  - `AccessTokenLifetimeSeconds`, `RefreshTokenLifetimeDays`
  - `TenantId`, `Enabled`
- `Scopes`（`Name` 唯一，`DisplayName`，`Resources`，`Claims`）

### 1.3 运行时对象
- `Authorizations`（用户 + 客户端 + Scope 的授权记录）
- `Tokens`（Refresh Token/Reference Token；JTI、过期、撤销标记）
- `DeviceCodes`（设备授权，可选）
- `Consents`（用户同意记录）
- `Sessions`（会话 & 登出状态，`SessionId`）

### 1.4 审计与风控
- `AuditLogs`（操作人、对象、类型、结果、IP、UA、时间、租户）
- `LoginAttempts`（成功/失败、来源、外部提供者、耗时、错误码）
- `IpRules` / `ClientRules`（黑白名单、限流策略）

## 2. 索引建议
- `Users(NormalizedUserName)`、`Users(NormalizedEmail)`（唯一）
- `UserLogins(LoginProvider, ProviderKey)`（唯一）
- `Clients(ClientId)`（唯一）
- `Tokens(Jti)`（唯一）、`Tokens(UserId, ClientId, Type)`（包含索引）
- `AuditLogs(Timestamp)`、`AuditLogs(UserId)`

## 3. 迁移与切换
- `dotnet ef migrations add Init`
- `dotnet ef database update`
- 多数据库切换：调整连接串与 Provider，迁移脚本需在各库验证。

## 4. 数据保留与清理
- 令牌与会话：过期 + 撤销后定期清理（批处理）
- 审计日志：保留 180 天（可配置）
