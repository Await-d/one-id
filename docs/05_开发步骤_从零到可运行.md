# 开发步骤｜从零到可运行

## 0. 环境准备
- Node.js LTS / PNPM
- .NET 9 SDK
- Docker / Docker Compose
- Redis、数据库（本地任选一种）

## 1. 后端骨架
```bash
mkdir backend && cd backend
dotnet new sln -n OneID
dotnet new webapi -n OneID.Identity
dotnet new webapi -n OneID.AdminApi
dotnet sln add OneID.Identity/OneID.Identity.csproj
dotnet sln add OneID.AdminApi/OneID.AdminApi.csproj
```

### 1.1 引入包（示例）
```bash
cd OneID.Identity
dotnet add package OpenIddict
dotnet add package OpenIddict.Server.AspNetCore
dotnet add package OpenIddict.EntityFrameworkCore
dotnet add package Microsoft.AspNetCore.Identity.EntityFrameworkCore
dotnet add package Microsoft.EntityFrameworkCore.SqlServer
dotnet add package Npgsql.EntityFrameworkCore.PostgreSQL
dotnet add package Pomelo.EntityFrameworkCore.MySql
dotnet add package Microsoft.EntityFrameworkCore.Sqlite
dotnet add package Serilog.AspNetCore
dotnet add package Swashbuckle.AspNetCore
dotnet add package Microsoft.AspNetCore.RateLimiting
```

### 1.2 Program.cs 关键片段（示意）
```csharp
builder.Services.AddDbContext<AppDbContext>(...);
builder.Services.AddIdentity<AppUser, IdentityRole>()
    .AddEntityFrameworkStores<AppDbContext>()
    .AddDefaultTokenProviders();

builder.Services.AddOpenIddict()
    .AddCore(o => o.UseEntityFrameworkCore().UseDbContext<AppDbContext>())
    .AddServer(o =>
    {
        o.SetTokenEndpointUris("/connect/token")
         .SetAuthorizationEndpointUris("/connect/authorize")
         .SetUserinfoEndpointUris("/connect/userinfo")
         .SetRevocationEndpointUris("/connect/revocation")
         .SetIntrospectionEndpointUris("/connect/introspect")
         .SetLogoutEndpointUris("/connect/endsession");

        o.AllowAuthorizationCodeFlow().RequireProofKeyForCodeExchange();
        o.AllowRefreshTokenFlow();
        o.RegisterScopes("openid", "profile", "email", "offline_access");

        o.AddDevelopmentEncryptionCertificate()
         .AddDevelopmentSigningCertificate();

        o.UseAspNetCore()
         .EnableAuthorizationEndpointPassthrough()
         .EnableTokenEndpointPassthrough()
         .EnableUserinfoEndpointPassthrough();
    })
    .AddValidation(o => o.UseLocalServer());
```

### 1.3 外部登录（示例注册）
- 使用 `AddAuthentication().AddOAuth("GitHub", ...)` / Google / Gitee / 微信（自定义 OAuth）
- 统一回调到 `/external/signin/{provider}` 并在控制器中完成绑定逻辑。

### 1.4 初始化种子数据
- 创建平台管理员、默认客户端（`spa.portal`）、默认作用域；写入数据库。

## 2. 前端骨架（登录站点与管理台）
```bash
mkdir -p frontend && cd frontend
pnpm create vite login --template react-ts
pnpm create vite admin --template react-ts
cd login && pnpm i react-router-dom @tanstack/react-query axios oidc-client-ts antd
cd ../admin && pnpm i react-router-dom @tanstack/react-query axios antd
```

### 2.1 登录站点集成 OIDC（示意）
```ts
// auth.ts
import { UserManager } from "oidc-client-ts";
export const um = new UserManager({
  authority: import.meta.env.VITE_OIDC_ISSUER,
  client_id: "spa.portal",
  redirect_uri: `${location.origin}/callback`,
  response_type: "code",
  scope: "openid profile email offline_access",
});
```

## 3. 本地运行（Docker Compose 示例）
```yaml
# docker-compose.dev.yml
services:
  db:
    image: postgres:16
    environment:
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: oneid
    ports: ["5432:5432"]
  redis:
    image: redis:7
    ports: ["6379:6379"]
  oneid:
    build: ./backend/OneID.Identity
    environment:
      ConnectionStrings__Default: "Host=db;Username=postgres;Password=postgres;Database=oneid"
    ports: ["5000:8080"]
    depends_on: [db, redis]
```

## 4. 最小闭环验证
1) 访问登录站点 → 触发授权 → 回调 → 换取 Token；  
2) 使用 Access Token 请求管理 API（或用户信息 `userinfo`）；  
3) 打开 Swagger 验证受保护 API；  
4) 观察日志、指标、追踪是否正常。

## 5. 多数据库切换
- 替换 Provider 与连接串，执行迁移并跑通健康检查。

## 6. 代码质量与安全
- 启用 `dotnet analyzers`、`ESLint/Prettier`、预提交 Hook；
- 打开 `.http`/`REST Client` 脚本做本地冒烟；
- 配置速率限制与 CORS 白名单；开启 HTTPS。

