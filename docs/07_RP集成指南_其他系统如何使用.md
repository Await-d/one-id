# RP（依赖方）集成指南｜如何使用 OneID

## 1. 快速开始
1) 在管理台创建客户端（`client_id`/`client_secret`、回调 URI、允许作用域）；  
2) 在应用中使用 OIDC 客户端库（Web：oidc-client-ts / 后端：OpenIddict/任何 OIDC Client）；  
3) 按授权码 + PKCE 流程完成跳转登录与令牌交换。

## 2. 浏览器 SPA（React）示例
```ts
import { UserManager } from "oidc-client-ts";
const um = new UserManager({
  authority: "https://oneid.example.com",
  client_id: "spa.portal",
  redirect_uri: "https://rp.example.com/callback",
  response_type: "code",
  scope: "openid profile email offline_access"
});

export async function login() { await um.signinRedirect(); }
export async function callback() { const u = await um.signinRedirectCallback(); return u; }
export async function logout() { await um.signoutRedirect(); }
```

## 3. 服务端（Node.js）验证 Access Token（JWT）
```js
import jwks from "jwks-rsa";
import jwt from "jsonwebtoken";

const client = jwks({ jwksUri: "https://oneid.example.com/.well-known/jwks.json" });

function getKey(header, cb) {
  client.getSigningKey(header.kid, (err, key) => {
    const signingKey = key.getPublicKey();
    cb(null, signingKey);
  });
}

export function verify(token) {
  return new Promise((resolve, reject) => {
    jwt.verify(token, getKey, { audience: "api://rp", issuer: "https://oneid.example.com", algorithms: ["RS256"] }, (err, decoded) => {
      if (err) reject(err); else resolve(decoded);
    });
  });
}
```

## 4. 后端对后端（client_credentials）
- 创建机机客户端，配置受众（Audience）；
- 以 `client_id` + `client_secret` 调用 `/connect/token` 获取 Access Token；
- 建议使用 MTLS/网关白名单等增强安全。

## 5. 注销
- 注册 `post_logout_redirect_uri`，调用 `/connect/endsession?id_token_hint=...&post_logout_redirect_uri=...`。

## 6. 常见问题
- **CORS**：将 `https://rp.example.com` 加入 Allowed Origins；  
- **时间同步**：令牌校验依赖服务器时间，请保证 NTP 同步；  
- **回调 URI 不匹配**：必须与注册信息完全一致（大小写/路径/协议）。
