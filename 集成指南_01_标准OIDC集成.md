# æ ‡å‡† OIDC é›†æˆæŒ‡å—

> æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»å¦‚ä½•ä½¿ç”¨æ ‡å‡† OpenID Connect (OIDC) åè®®å°†ä½ çš„åº”ç”¨ä¸ OneID é›†æˆã€‚

## ğŸ“‹ ç›®å½•

- [æ¦‚è¿°](#æ¦‚è¿°)
- [å‰ç½®æ¡ä»¶](#å‰ç½®æ¡ä»¶)
- [é›†æˆæ­¥éª¤](#é›†æˆæ­¥éª¤)
- [å¹³å°ç‰¹å®šç¤ºä¾‹](#å¹³å°ç‰¹å®šç¤ºä¾‹)
- [é«˜çº§é…ç½®](#é«˜çº§é…ç½®)
- [æ•…éšœæ’é™¤](#æ•…éšœæ’é™¤)

---

## ğŸ¯ æ¦‚è¿°

### ä»€ä¹ˆæ˜¯æ ‡å‡† OIDC é›†æˆï¼Ÿ

æ ‡å‡† OIDC é›†æˆæ˜¯æœ€ç®€å•ã€æœ€å®‰å…¨çš„é›†æˆæ–¹å¼ã€‚ä½ çš„åº”ç”¨å°†ç”¨æˆ·é‡å®šå‘åˆ° OneID çš„ç™»å½•é¡µé¢ï¼Œç”¨æˆ·å®Œæˆè®¤è¯åï¼ŒOneID å°†ç”¨æˆ·é‡å®šå‘å›ä½ çš„åº”ç”¨ï¼Œå¹¶æºå¸¦èº«ä»½ä¿¡æ¯ã€‚

### ç”¨æˆ·æµç¨‹

```
1. ç”¨æˆ·è®¿é—®ä½ çš„åº”ç”¨
   â†“
2. ç‚¹å‡»"ç™»å½•"æŒ‰é’®
   â†“
3. è·³è½¬åˆ° OneID ç™»å½•é¡µ
   â†“
4. ç”¨æˆ·é€‰æ‹©ç™»å½•æ–¹å¼ï¼š
   - ç”¨æˆ·åå¯†ç ç™»å½•
   - GitHub ç™»å½•
   - Google ç™»å½•
   - Gitee ç™»å½•
   - å¾®ä¿¡ç™»å½•
   â†“
5. å®Œæˆè®¤è¯ï¼ˆå¯èƒ½éœ€è¦åŒå› ç´ è®¤è¯ï¼‰
   â†“
6. è·³è½¬å›ä½ çš„åº”ç”¨ï¼ˆæºå¸¦æˆæƒç ï¼‰
   â†“
7. ä½ çš„åº”ç”¨ç”¨æˆæƒç æ¢å– Token
   â†“
8. ç”¨æˆ·ç™»å½•æˆåŠŸï¼
```

### OneID ç™»å½•é¡µæ•ˆæœ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         OneID ç™»å½•                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç”¨æˆ·å: [_______________]          â”‚
â”‚  å¯†ç :   [_______________]          â”‚
â”‚         [      ç™»å½•      ]          â”‚
â”‚                                     â”‚
â”‚  [    å¿˜è®°å¯†ç ï¼Ÿ    ]               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚       æˆ–ä½¿ç”¨ä»¥ä¸‹æ–¹å¼ç»§ç»­            â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ğŸ™  GitHub                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ğŸ”µ  Google                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ğŸŸ   Gitee                     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ğŸ’¬  å¾®ä¿¡                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¼˜åŠ¿

- âœ… **å¼€ç®±å³ç”¨**ï¼šæ— éœ€å¼€å‘ç™»å½•é¡µ
- âœ… **å®‰å…¨æ€§é«˜**ï¼šéµå¾ª OIDC æœ€ä½³å®è·µ
- âœ… **ç»Ÿä¸€ä½“éªŒ**ï¼šæ‰€æœ‰åº”ç”¨å…±äº«åŒä¸€ç™»å½•é¡µ
- âœ… **è‡ªåŠ¨æ›´æ–°**ï¼šæ”¯æŒçš„è®¤è¯æ–¹å¼ç”± OneID ç»Ÿä¸€ç®¡ç†
- âœ… **åŒå› ç´ è®¤è¯**ï¼šè‡ªåŠ¨æ”¯æŒ MFA
- âœ… **å•ç‚¹ç™»å½•**ï¼šä¸€æ¬¡ç™»å½•ï¼Œå¤šå¤„ä½¿ç”¨

---

## ğŸ“‹ å‰ç½®æ¡ä»¶

### 1. OneID æœåŠ¡å·²å¯åŠ¨

```bash
# å¯åŠ¨ OneID
cd backend
docker-compose up -d

# éªŒè¯æœåŠ¡
curl http://localhost:5001/.well-known/openid-configuration
```

### 2. æ³¨å†Œå®¢æˆ·ç«¯åº”ç”¨

åœ¨ OneID Admin Portal æ³¨å†Œä½ çš„åº”ç”¨ï¼š

1. è®¿é—® http://localhost:5174
2. ç™»å½•ç®¡ç†åå°ï¼ˆé»˜è®¤è´¦å·ï¼šadmin / Admin@123ï¼‰
3. è¿›å…¥"å®¢æˆ·ç«¯ç®¡ç†"
4. ç‚¹å‡»"åˆ›å»ºå®¢æˆ·ç«¯"

**é…ç½®ç¤ºä¾‹**ï¼š

| å­—æ®µ | å€¼ | è¯´æ˜ |
|------|-----|------|
| Client ID | `my-app` | å®¢æˆ·ç«¯å”¯ä¸€æ ‡è¯† |
| Client Name | `My Application` | æ˜¾ç¤ºåç§° |
| Client Type | `Web Application` | åº”ç”¨ç±»å‹ |
| Grant Types | `Authorization Code` | æˆæƒç±»å‹ |
| Redirect URIs | `http://localhost:3000/callback` | å›è°ƒåœ°å€ |
| Post Logout Redirect URIs | `http://localhost:3000` | ç™»å‡ºåè·³è½¬åœ°å€ |
| Scopes | `openid profile email` | è¯·æ±‚çš„æƒé™èŒƒå›´ |
| Require PKCE | âœ… æ˜¯ | å…¬å…±å®¢æˆ·ç«¯å¿…é¡»å¯ç”¨ |
| Require Client Secret | âœ… æ˜¯ï¼ˆæœåŠ¡ç«¯åº”ç”¨ï¼‰<br>âŒ å¦ï¼ˆSPA/ç§»åŠ¨åº”ç”¨ï¼‰ | æ˜¯å¦éœ€è¦å¯†é’¥ |

ä¿å­˜åï¼Œç³»ç»Ÿä¼šç”Ÿæˆ `Client Secret`ï¼ˆå¦‚æœéœ€è¦ï¼‰ï¼Œè¯·å¦¥å–„ä¿ç®¡ã€‚

---

## ğŸš€ é›†æˆæ­¥éª¤

### æ­¥éª¤ 1: å®‰è£… OIDC å®¢æˆ·ç«¯åº“

æ ¹æ®ä½ çš„æŠ€æœ¯æ ˆé€‰æ‹©ï¼š

#### JavaScript/TypeScript (React/Vue/Angular)

```bash
npm install oidc-client-ts
# æˆ–
yarn add oidc-client-ts
```

#### .NET

```bash
dotnet add package Microsoft.AspNetCore.Authentication.OpenIdConnect
```

#### Python

```bash
pip install authlib
```

#### Java

```xml
<!-- pom.xml -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-oauth2-client</artifactId>
</dependency>
```

---

### æ­¥éª¤ 2: é…ç½® OIDC å®¢æˆ·ç«¯

#### JavaScript/TypeScript ç¤ºä¾‹

```typescript
// src/auth/oidcConfig.ts
import { UserManager, WebStorageStateStore } from 'oidc-client-ts';

const oidcConfig = {
  // OneID æœåŠ¡åœ°å€
  authority: 'http://localhost:5001',
  
  // å®¢æˆ·ç«¯é…ç½®
  client_id: 'my-app',
  client_secret: 'your-client-secret', // ä»…æœåŠ¡ç«¯åº”ç”¨éœ€è¦
  
  // å›è°ƒåœ°å€ï¼ˆå¿…é¡»åœ¨ OneID ä¸­æ³¨å†Œï¼‰
  redirect_uri: 'http://localhost:3000/callback',
  post_logout_redirect_uri: 'http://localhost:3000',
  
  // æˆæƒæµç¨‹
  response_type: 'code', // æˆæƒç æ¨¡å¼
  scope: 'openid profile email',
  
  // è‡ªåŠ¨åˆ·æ–° Token
  automaticSilentRenew: true,
  silent_redirect_uri: 'http://localhost:3000/silent-renew',
  
  // Token å­˜å‚¨
  userStore: new WebStorageStateStore({ store: window.localStorage }),
  
  // é«˜çº§é…ç½®
  loadUserInfo: true, // è‡ªåŠ¨åŠ è½½ç”¨æˆ·ä¿¡æ¯
  monitorSession: true, // ç›‘æ§ä¼šè¯çŠ¶æ€
  checkSessionIntervalInSeconds: 10,
  
  // PKCEï¼ˆå…¬å…±å®¢æˆ·ç«¯å¿…é¡»å¯ç”¨ï¼‰
  code_challenge_method: 'S256',
};

export const userManager = new UserManager(oidcConfig);

// äº‹ä»¶ç›‘å¬
userManager.events.addAccessTokenExpiring(() => {
  console.log('Token å³å°†è¿‡æœŸï¼Œè‡ªåŠ¨ç»­æœŸ...');
});

userManager.events.addAccessTokenExpired(() => {
  console.log('Token å·²è¿‡æœŸï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µ...');
  userManager.signinRedirect();
});

userManager.events.addUserLoaded((user) => {
  console.log('ç”¨æˆ·ä¿¡æ¯å·²åŠ è½½:', user.profile);
});

userManager.events.addUserUnloaded(() => {
  console.log('ç”¨æˆ·å·²æ³¨é”€');
});
```

---

### æ­¥éª¤ 3: å®ç°ç™»å½•åŠŸèƒ½

#### React ç¤ºä¾‹

```typescript
// src/components/LoginButton.tsx
import React from 'react';
import { userManager } from '../auth/oidcConfig';

export function LoginButton() {
  const handleLogin = async () => {
    try {
      // ä¿å­˜å½“å‰é¡µé¢è·¯å¾„ï¼Œç™»å½•åè¿”å›
      sessionStorage.setItem('preLoginPath', window.location.pathname);
      
      // å‘èµ·ç™»å½•ï¼ˆè·³è½¬åˆ° OneIDï¼‰
      await userManager.signinRedirect({
        state: { returnUrl: window.location.pathname }
      });
    } catch (error) {
      console.error('ç™»å½•å¤±è´¥:', error);
    }
  };

  return (
    <button
      onClick={handleLogin}
      className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
    >
      ç™»å½•
    </button>
  );
}
```

```typescript
// src/pages/CallbackPage.tsx
import React, { useEffect, useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { userManager } from '../auth/oidcConfig';

export function CallbackPage() {
  const navigate = useNavigate();
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    const handleCallback = async () => {
      try {
        // å¤„ç†å›è°ƒï¼Œè·å–ç”¨æˆ·ä¿¡æ¯
        const user = await userManager.signinRedirectCallback();
        
        console.log('ç™»å½•æˆåŠŸï¼ç”¨æˆ·ä¿¡æ¯:', user.profile);
        console.log('Access Token:', user.access_token);
        console.log('ID Token:', user.id_token);
        
        // è·³è½¬åˆ°ç™»å½•å‰çš„é¡µé¢
        const returnUrl = user.state?.returnUrl || '/';
        navigate(returnUrl);
      } catch (err) {
        console.error('ç™»å½•å›è°ƒå¤„ç†å¤±è´¥:', err);
        setError(err.message);
      }
    };

    handleCallback();
  }, [navigate]);

  if (error) {
    return (
      <div className="error">
        <h2>ç™»å½•å¤±è´¥</h2>
        <p>{error}</p>
        <button onClick={() => navigate('/')}>è¿”å›é¦–é¡µ</button>
      </div>
    );
  }

  return (
    <div className="loading">
      <p>æ­£åœ¨ç™»å½•ï¼Œè¯·ç¨å€™...</p>
    </div>
  );
}
```

---

### æ­¥éª¤ 4: å®ç°ç™»å‡ºåŠŸèƒ½

```typescript
// src/components/LogoutButton.tsx
import React from 'react';
import { userManager } from '../auth/oidcConfig';

export function LogoutButton() {
  const handleLogout = async () => {
    try {
      // ä» OneID æ³¨é”€ï¼ˆä¼šæ¸…é™¤ OneID çš„ä¼šè¯ï¼‰
      await userManager.signoutRedirect();
      
      // æˆ–è€…ä»…ä»æœ¬åœ°æ³¨é”€ï¼ˆä¸å½±å“å…¶ä»–åº”ç”¨ï¼‰
      // await userManager.removeUser();
      // window.location.href = '/';
    } catch (error) {
      console.error('ç™»å‡ºå¤±è´¥:', error);
    }
  };

  return (
    <button
      onClick={handleLogout}
      className="text-gray-600 hover:text-gray-900"
    >
      ç™»å‡º
    </button>
  );
}
```

---

### æ­¥éª¤ 5: ä¿æŠ¤å—é™è·¯ç”±

```typescript
// src/components/ProtectedRoute.tsx
import React, { useEffect, useState } from 'react';
import { Navigate } from 'react-router-dom';
import { userManager } from '../auth/oidcConfig';

interface ProtectedRouteProps {
  children: React.ReactNode;
}

export function ProtectedRoute({ children }: ProtectedRouteProps) {
  const [isAuthenticated, setIsAuthenticated] = useState<boolean | null>(null);

  useEffect(() => {
    const checkAuth = async () => {
      try {
        const user = await userManager.getUser();
        setIsAuthenticated(user !== null && !user.expired);
      } catch (error) {
        console.error('æ£€æŸ¥è®¤è¯çŠ¶æ€å¤±è´¥:', error);
        setIsAuthenticated(false);
      }
    };

    checkAuth();
  }, []);

  // åŠ è½½ä¸­
  if (isAuthenticated === null) {
    return <div>Loading...</div>;
  }

  // æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µ
  if (!isAuthenticated) {
    return <Navigate to="/login" replace />;
  }

  // å·²ç™»å½•ï¼Œæ˜¾ç¤ºå†…å®¹
  return <>{children}</>;
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```typescript
// src/App.tsx
import { BrowserRouter, Routes, Route } from 'react-router-dom';
import { HomePage } from './pages/HomePage';
import { DashboardPage } from './pages/DashboardPage';
import { CallbackPage } from './pages/CallbackPage';
import { ProtectedRoute } from './components/ProtectedRoute';

function App() {
  return (
    <BrowserRouter>
      <Routes>
        <Route path="/" element={<HomePage />} />
        <Route path="/callback" element={<CallbackPage />} />
        
        {/* å—ä¿æŠ¤çš„è·¯ç”± */}
        <Route
          path="/dashboard"
          element={
            <ProtectedRoute>
              <DashboardPage />
            </ProtectedRoute>
          }
        />
      </Routes>
    </BrowserRouter>
  );
}

export default App;
```

---

### æ­¥éª¤ 6: è·å–å’Œä½¿ç”¨ç”¨æˆ·ä¿¡æ¯

```typescript
// src/hooks/useAuth.ts
import { useState, useEffect } from 'react';
import { User } from 'oidc-client-ts';
import { userManager } from '../auth/oidcConfig';

export function useAuth() {
  const [user, setUser] = useState<User | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    // è·å–å½“å‰ç”¨æˆ·
    const loadUser = async () => {
      try {
        const currentUser = await userManager.getUser();
        setUser(currentUser);
      } catch (error) {
        console.error('åŠ è½½ç”¨æˆ·å¤±è´¥:', error);
      } finally {
        setLoading(false);
      }
    };

    loadUser();

    // ç›‘å¬ç”¨æˆ·å˜åŒ–
    const handleUserLoaded = (user: User) => setUser(user);
    const handleUserUnloaded = () => setUser(null);

    userManager.events.addUserLoaded(handleUserLoaded);
    userManager.events.addUserUnloaded(handleUserUnloaded);

    return () => {
      userManager.events.removeUserLoaded(handleUserLoaded);
      userManager.events.removeUserUnloaded(handleUserUnloaded);
    };
  }, []);

  return {
    user,
    loading,
    isAuthenticated: user !== null && !user.expired,
    profile: user?.profile,
    accessToken: user?.access_token,
    login: () => userManager.signinRedirect(),
    logout: () => userManager.signoutRedirect(),
  };
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```typescript
// src/pages/DashboardPage.tsx
import React from 'react';
import { useAuth } from '../hooks/useAuth';

export function DashboardPage() {
  const { user, profile, loading, logout } = useAuth();

  if (loading) {
    return <div>Loading...</div>;
  }

  return (
    <div className="dashboard">
      <header>
        <h1>æ¬¢è¿ï¼Œ{profile.name || profile.email}ï¼</h1>
        <button onClick={logout}>ç™»å‡º</button>
      </header>

      <div className="user-info">
        <h2>ç”¨æˆ·ä¿¡æ¯</h2>
        <dl>
          <dt>ç”¨æˆ· ID (sub):</dt>
          <dd>{profile.sub}</dd>
          
          <dt>é‚®ç®±:</dt>
          <dd>{profile.email}</dd>
          
          <dt>é‚®ç®±å·²éªŒè¯:</dt>
          <dd>{profile.email_verified ? 'æ˜¯' : 'å¦'}</dd>
          
          <dt>å§“å:</dt>
          <dd>{profile.name}</dd>
          
          <dt>ç”¨æˆ·å:</dt>
          <dd>{profile.preferred_username}</dd>
        </dl>
      </div>

      <div className="token-info">
        <h2>Token ä¿¡æ¯</h2>
        <dl>
          <dt>Access Token è¿‡æœŸæ—¶é—´:</dt>
          <dd>{new Date(user.expires_at * 1000).toLocaleString()}</dd>
          
          <dt>Token ç±»å‹:</dt>
          <dd>{user.token_type}</dd>
          
          <dt>Scopes:</dt>
          <dd>{user.scope}</dd>
        </dl>
      </div>
    </div>
  );
}
```

---

### æ­¥éª¤ 7: è°ƒç”¨å—ä¿æŠ¤çš„ API

```typescript
// src/lib/apiClient.ts
import { userManager } from '../auth/oidcConfig';

export class ApiClient {
  private baseUrl: string;

  constructor(baseUrl: string) {
    this.baseUrl = baseUrl;
  }

  private async getAccessToken(): Promise<string | null> {
    const user = await userManager.getUser();
    return user?.access_token || null;
  }

  async get<T>(path: string): Promise<T> {
    const token = await this.getAccessToken();
    
    const response = await fetch(`${this.baseUrl}${path}`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json',
      },
    });

    if (!response.ok) {
      if (response.status === 401) {
        // Token æ— æ•ˆæˆ–è¿‡æœŸï¼Œé‡æ–°ç™»å½•
        await userManager.signinRedirect();
      }
      throw new Error(`API è¯·æ±‚å¤±è´¥: ${response.statusText}`);
    }

    return response.json();
  }

  async post<T>(path: string, data: any): Promise<T> {
    const token = await this.getAccessToken();
    
    const response = await fetch(`${this.baseUrl}${path}`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(data),
    });

    if (!response.ok) {
      if (response.status === 401) {
        await userManager.signinRedirect();
      }
      throw new Error(`API è¯·æ±‚å¤±è´¥: ${response.statusText}`);
    }

    return response.json();
  }
}

// å¯¼å‡ºå•ä¾‹
export const apiClient = new ApiClient('http://localhost:5000');
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```typescript
// src/pages/DataPage.tsx
import React, { useEffect, useState } from 'react';
import { apiClient } from '../lib/apiClient';

interface DataItem {
  id: string;
  name: string;
}

export function DataPage() {
  const [data, setData] = useState<DataItem[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const loadData = async () => {
      try {
        // è°ƒç”¨å—ä¿æŠ¤çš„ APIï¼ˆè‡ªåŠ¨æºå¸¦ Bearer Tokenï¼‰
        const items = await apiClient.get<DataItem[]>('/api/data');
        setData(items);
      } catch (error) {
        console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
      } finally {
        setLoading(false);
      }
    };

    loadData();
  }, []);

  if (loading) {
    return <div>Loading...</div>;
  }

  return (
    <div>
      <h1>æ•°æ®åˆ—è¡¨</h1>
      <ul>
        {data.map(item => (
          <li key={item.id}>{item.name}</li>
        ))}
      </ul>
    </div>
  );
}
```

---

## ğŸŒ å¹³å°ç‰¹å®šç¤ºä¾‹

### .NET ç¤ºä¾‹

```csharp
// Program.cs
using Microsoft.AspNetCore.Authentication.Cookies;
using Microsoft.AspNetCore.Authentication.OpenIdConnect;

var builder = WebApplication.CreateBuilder(args);

builder.Services.AddAuthentication(options =>
{
    options.DefaultScheme = CookieAuthenticationDefaults.AuthenticationScheme;
    options.DefaultChallengeScheme = OpenIdConnectDefaults.AuthenticationScheme;
})
.AddCookie()
.AddOpenIdConnect(options =>
{
    options.Authority = "http://localhost:5001";
    options.ClientId = "dotnet-app";
    options.ClientSecret = "your-client-secret";
    options.ResponseType = "code";
    
    options.Scope.Clear();
    options.Scope.Add("openid");
    options.Scope.Add("profile");
    options.Scope.Add("email");
    
    options.SaveTokens = true;
    options.GetClaimsFromUserInfoEndpoint = true;
    
    // æœ¬åœ°å¼€å‘ç¦ç”¨ HTTPS éªŒè¯
    options.RequireHttpsMetadata = false;
    
    options.CallbackPath = "/signin-oidc";
    options.SignedOutCallbackPath = "/signout-callback-oidc";
});

builder.Services.AddAuthorization();

var app = builder.Build();

app.UseAuthentication();
app.UseAuthorization();

// ç™»å½•ç«¯ç‚¹
app.MapGet("/login", async (HttpContext context) =>
{
    await context.ChallengeAsync(OpenIdConnectDefaults.AuthenticationScheme,
        new AuthenticationProperties { RedirectUri = "/" });
});

// ç™»å‡ºç«¯ç‚¹
app.MapGet("/logout", async (HttpContext context) =>
{
    await context.SignOutAsync(CookieAuthenticationDefaults.AuthenticationScheme);
    await context.SignOutAsync(OpenIdConnectDefaults.AuthenticationScheme);
});

// å—ä¿æŠ¤çš„ç«¯ç‚¹
app.MapGet("/profile", (HttpContext context) =>
{
    var user = context.User;
    return new
    {
        Sub = user.FindFirst("sub")?.Value,
        Name = user.FindFirst("name")?.Value,
        Email = user.FindFirst("email")?.Value,
    };
}).RequireAuthorization();

app.Run();
```

---

### Python (FastAPI) ç¤ºä¾‹

```python
# main.py
from fastapi import FastAPI, Depends, Request
from fastapi.responses import RedirectResponse
from authlib.integrations.starlette_client import OAuth
from starlette.middleware.sessions import SessionMiddleware

app = FastAPI()

# æ·»åŠ ä¼šè¯ä¸­é—´ä»¶
app.add_middleware(SessionMiddleware, secret_key="your-secret-key")

# é…ç½® OAuth
oauth = OAuth()
oauth.register(
    name='oneid',
    client_id='python-app',
    client_secret='your-client-secret',
    server_metadata_url='http://localhost:5001/.well-known/openid-configuration',
    client_kwargs={
        'scope': 'openid profile email'
    }
)

@app.get('/login')
async def login(request: Request):
    redirect_uri = request.url_for('auth_callback')
    return await oauth.oneid.authorize_redirect(request, redirect_uri)

@app.get('/callback')
async def auth_callback(request: Request):
    token = await oauth.oneid.authorize_access_token(request)
    user_info = token.get('userinfo')
    
    # ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°ä¼šè¯
    request.session['user'] = user_info
    
    return RedirectResponse(url='/')

@app.get('/logout')
async def logout(request: Request):
    request.session.clear()
    return RedirectResponse(url='http://localhost:5001/connect/endsession')

@app.get('/profile')
async def profile(request: Request):
    user = request.session.get('user')
    if not user:
        return RedirectResponse(url='/login')
    return user
```

---

## âš™ï¸ é«˜çº§é…ç½®

### 1. æŒ‡å®šç™»å½•æ–¹å¼ï¼ˆç›´æ¥è·³è½¬åˆ°ç¬¬ä¸‰æ–¹ç™»å½•ï¼‰

```typescript
// ç›´æ¥è·³è½¬åˆ° GitHub ç™»å½•
await userManager.signinRedirect({
  extraQueryParams: {
    acr_values: 'idp:GitHub', // æˆ– 'idp:Google', 'idp:Gitee', 'idp:Wechat'
  }
});
```

### 2. å¤šè¯­è¨€æ”¯æŒ

```typescript
await userManager.signinRedirect({
  extraQueryParams: {
    ui_locales: 'zh-CN', // æˆ– 'en-US'
  }
});
```

### 3. è¯·æ±‚é¢å¤–çš„æƒé™èŒƒå›´

```typescript
const userManager = new UserManager({
  // ... å…¶ä»–é…ç½®
  scope: 'openid profile email phone address roles', // è¯·æ±‚æ›´å¤š Scopes
});
```

### 4. è‡ªå®šä¹‰ç™»å½•æç¤º

```typescript
// æ€»æ˜¯æ˜¾ç¤ºç™»å½•é¡µï¼ˆå³ä½¿ç”¨æˆ·å·²ç™»å½•ï¼‰
await userManager.signinRedirect({
  extraQueryParams: {
    prompt: 'login',
  }
});

// æ€»æ˜¯æ˜¾ç¤ºåŒæ„é¡µ
await userManager.signinRedirect({
  extraQueryParams: {
    prompt: 'consent',
  }
});
```

---

## ğŸ”§ æ•…éšœæ’é™¤

### é—®é¢˜ 1: æ— æ³•è·³è½¬åˆ° OneID ç™»å½•é¡µ

**æ’æŸ¥**ï¼š
1. æ£€æŸ¥ OneID æœåŠ¡æ˜¯å¦å¯åŠ¨
2. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°é”™è¯¯
3. æ£€æŸ¥ CORS é…ç½®

**è§£å†³**ï¼šç¡®ä¿ OneID å…è®¸ä½ çš„åº”ç”¨åŸŸåï¼š

```csharp
// OneID.Identity/Program.cs
builder.Services.AddCors(options =>
{
    options.AddDefaultPolicy(policy =>
    {
        policy.WithOrigins("http://localhost:3000")
              .AllowAnyHeader()
              .AllowAnyMethod()
              .AllowCredentials();
    });
});
```

### é—®é¢˜ 2: å›è°ƒåæŠ¥é”™ "invalid_grant"

**åŸå› **ï¼šRedirect URI ä¸åŒ¹é…

**è§£å†³**ï¼šç¡®è®¤ Redirect URI å®Œå…¨åŒ¹é…ï¼ˆåŒ…æ‹¬åè®®ã€åŸŸåã€ç«¯å£ã€è·¯å¾„ï¼‰

### é—®é¢˜ 3: Token æ— æ³•åˆ·æ–°

**è§£å†³**ï¼šç¡®ä¿é…ç½®äº† `silent_redirect_uri` å¹¶åˆ›å»ºå¯¹åº”é¡µé¢

---

## ğŸ“š ç›¸å…³èµ„æº

- [OpenID Connect è§„èŒƒ](https://openid.net/specs/openid-connect-core-1_0.html)
- [oidc-client-ts æ–‡æ¡£](https://github.com/authts/oidc-client-ts)
- [è‡ªå®šä¹‰ç™»å½•é¡µé›†æˆ](./é›†æˆæŒ‡å—_02_è‡ªå®šä¹‰ç™»å½•é¡µé›†æˆ.md)

---

**é›†æˆå®Œæˆåï¼Œä½ çš„åº”ç”¨å°†æ”¯æŒ**ï¼š

- âœ… ç”¨æˆ·åå¯†ç ç™»å½•
- âœ… GitHub/Google/Gitee/å¾®ä¿¡å¿«æ·ç™»å½•
- âœ… åŒå› ç´ è®¤è¯
- âœ… å•ç‚¹ç™»å½•ï¼ˆSSOï¼‰
- âœ… è‡ªåŠ¨ Token åˆ·æ–°
- âœ… å®‰å…¨çš„ä¼šè¯ç®¡ç†

Happy Coding! ğŸš€

