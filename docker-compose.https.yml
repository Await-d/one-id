# ============================================================
# OneID ç”Ÿäº§ç¯å¢ƒ HTTPS éƒ¨ç½²é…ç½®
# ============================================================
# 
# ğŸ“‹ éƒ¨ç½²æ¶æ„ï¼š
#   - Identity Server (ç™»å½•ç•Œé¢ + OIDC Provider)  -> https://domain:9443
#   - Admin Portal (ç®¡ç†åå°)                     -> https://domain:9444
#   - PostgreSQL (æ•°æ®åº“)
#   - Redis (ç¼“å­˜)
#   - Nginx (HTTPSåå‘ä»£ç†)
#
# ğŸ” HTTPS é…ç½®ï¼š
#   1. ç”ŸæˆSSLè¯ä¹¦ï¼š
#      cd nginx/ssl
#      ./generate-cert.sh
#   2. æˆ–ä½¿ç”¨è‡ªå·±çš„è¯ä¹¦ï¼Œæ”¾ç½®åœ¨ nginx/ssl/ ç›®å½•
#
# ğŸš€ å¿«é€Ÿå¼€å§‹ï¼š
#   1. åˆ›å»º .env æ–‡ä»¶å¹¶é…ç½®åŸŸå/IP
#   2. docker compose -f docker-compose.https.yml up -d
#
# ğŸ“ ç¯å¢ƒå˜é‡è¯´æ˜ï¼š
#   DOMAIN           - éƒ¨ç½²åŸŸå/IP (å¦‚: sso.company.com æˆ– 192.168.123.9)
#   POSTGRES_PASSWORD - æ•°æ®åº“å¯†ç 
#   ADMIN_USERNAME   - ç®¡ç†å‘˜ç”¨æˆ·å
#   ADMIN_PASSWORD   - ç®¡ç†å‘˜å¯†ç 
#   ADMIN_EMAIL      - ç®¡ç†å‘˜é‚®ç®±
#
# ğŸ”§ é«˜çº§é…ç½®ï¼ˆå¯é€‰ï¼‰ï¼š
#   IDENTITY_PORT        - Identity Server HTTPSç«¯å£ï¼ˆé»˜è®¤: 9443ï¼‰
#   ADMIN_PORT           - Admin Portal HTTPSç«¯å£ï¼ˆé»˜è®¤: 9444ï¼‰
#   HTTP_PORT            - HTTPç«¯å£ï¼Œè‡ªåŠ¨é‡å®šå‘åˆ°HTTPSï¼ˆé»˜è®¤: 9080ï¼‰
#   ADMIN_REDIRECT_URIS  - Admin Portalå›è°ƒåœ°å€ï¼ˆå¤šä¸ªç”¨é€—å·åˆ†éš”ï¼‰
#                          é»˜è®¤: https://${DOMAIN}:${ADMIN_PORT}/callback
#                          ç¤ºä¾‹: https://admin.company.com/callback,https://192.168.1.100:8443/callback
#   ADMIN_LOGOUT_URIS    - Admin Portalç™»å‡ºå›è°ƒåœ°å€ï¼ˆå¤šä¸ªç”¨é€—å·åˆ†éš”ï¼‰
#                          é»˜è®¤: https://${DOMAIN}:${ADMIN_PORT}
#                          ç¤ºä¾‹: https://admin.company.com,https://192.168.1.100:8443
#
# ============================================================

services:
  # ============================================================
  # PostgreSQL æ•°æ®åº“
  # ============================================================
  postgres:
    image: postgres:16-alpine
    container_name: oneid-postgres-prod
    environment:
      POSTGRES_USER: oneid
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-oneid_prod_password_change_me}
      POSTGRES_DB: oneid
      # æ€§èƒ½ä¼˜åŒ–é…ç½®
      POSTGRES_INITDB_ARGS: "-E UTF8 --locale=C"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - oneid-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U oneid"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    # èµ„æºé™åˆ¶ï¼ˆå¯é€‰ï¼Œæ ¹æ®å®é™…æƒ…å†µè°ƒæ•´ï¼‰
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '2'
    #       memory: 2G
    #     reservations:
    #       memory: 512M

  # ============================================================
  # Redis ç¼“å­˜
  # ============================================================
  redis:
    image: redis:7-alpine
    container_name: oneid-redis-prod
    command: redis-server --appendonly yes
    volumes:
      - redis-data:/data
    networks:
      - oneid-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s
    restart: unless-stopped

  # ============================================================
  # Identity Server (OIDC Provider + ä¼˜åŒ–åçš„ç™»å½• SPA)
  # ============================================================
  identity:
    build:
      context: .
      dockerfile: Dockerfile
    image: oneid-identity:latest
    container_name: oneid-identity
    environment:
      # ASP.NET Core é…ç½®
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://0.0.0.0:80
      
      # æ•°æ®åº“è¿æ¥
      - ConnectionStrings__Default=Host=postgres;Port=5432;Database=oneid;Username=oneid;Password=${POSTGRES_PASSWORD:-oneid_prod_password_change_me}
      - Persistence__Provider=Postgres
      - Persistence__ConnectionName=Default
      - Persistence__EnableSensitiveLogging=false  # ç”Ÿäº§ç¯å¢ƒç¦ç”¨æ•æ„Ÿæ•°æ®æ—¥å¿—
      
      # ç®¡ç†å‘˜è´¦å·é…ç½®
      - Seed__Admin__Email=${ADMIN_EMAIL:-admin@oneid.local}
      - Seed__Admin__UserName=${ADMIN_USERNAME:-admin}
      - Seed__Admin__Password=${ADMIN_PASSWORD:-Admin@123456}
      - Seed__Admin__DisplayName=${ADMIN_DISPLAY_NAME:-Platform Administrator}
      - Seed__Admin__Role=PlatformAdmin
      
      # OIDC å®¢æˆ·ç«¯é…ç½®ï¼ˆç™»å½• SPAï¼‰
      # é‡è¦ï¼šç¡®ä¿ DOMAIN å’Œç«¯å£ç¯å¢ƒå˜é‡è®¾ç½®æ­£ç¡®
      - Seed__Oidc__ClientId=spa.portal
      - Seed__Oidc__DisplayName=OneID Portal
      - Seed__Oidc__RedirectUri=https://${DOMAIN:-192.168.123.9}:${IDENTITY_PORT:-9443}/callback
      - Seed__Oidc__PostLogoutRedirectUri=https://${DOMAIN:-192.168.123.9}:${IDENTITY_PORT:-9443}
      - Seed__Oidc__Scopes__0=openid
      - Seed__Oidc__Scopes__1=profile
      - Seed__Oidc__Scopes__2=email
      - Seed__Oidc__Scopes__3=offline_access
      
      # Redis é…ç½®
      - Redis__Configuration=redis:6379
      
      # CORS é…ç½® - å…è®¸Admin Portalè®¿é—®
      # é‡è¦ï¼šè¿™ä¸ªç¯å¢ƒå˜é‡ä¼šåœ¨æ•°æ®åº“åˆå§‹åŒ–æ—¶è®¾ç½® CORS ç™½åå•
      - IDENTITY_CORS_ALLOWED_ORIGINS=http://localhost:5173,https://${DOMAIN:-192.168.123.9}:${ADMIN_PORT:-9444},http://localhost:5102
      
      # Admin Portal OIDC é…ç½®
      # é…ç½®Admin Portalçš„redirect_uriå’Œlogout_uriï¼ˆæ”¯æŒè‡ªå®šä¹‰æˆ–å¤šä¸ªåœ°å€ï¼Œç”¨é€—å·åˆ†éš”ï¼‰
      # å¦‚æœè®¾ç½®äº† ADMIN_REDIRECT_URIS ç¯å¢ƒå˜é‡ï¼Œåˆ™ä½¿ç”¨å®ƒï¼›å¦åˆ™ä½¿ç”¨é»˜è®¤å€¼
      - ADMIN_REDIRECT_URIS=${ADMIN_REDIRECT_URIS:-https://${DOMAIN:-192.168.123.9}:${ADMIN_PORT:-9444}/callback}
      - ADMIN_LOGOUT_URIS=${ADMIN_LOGOUT_URIS:-https://${DOMAIN:-192.168.123.9}:${ADMIN_PORT:-9444}}
      
      # Data Protection é…ç½® - å…±äº«å¯†é’¥ç›®å½•
      - DataProtection__ApplicationName=${DATAPROTECTION_APP_NAME:-OneID}
      - DataProtection__KeysPath=/app/shared-keys
      
    volumes:
      - dataprotection-keys:/app/shared-keys
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - oneid-network
    restart: unless-stopped
    # å¥åº·æ£€æŸ¥ - ä½¿ç”¨ä¸“ç”¨å¥åº·æ£€æŸ¥ç«¯ç‚¹
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost/api/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s

  # ============================================================
  # Admin API + ä¼˜åŒ–åçš„ç®¡ç†åå° SPA
  # ============================================================
  adminapi:
    build:
      context: .
      dockerfile: Dockerfile.adminapi
    image: oneid-adminapi:latest
    container_name: oneid-adminapi
    environment:
      # ASP.NET Core é…ç½®
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://0.0.0.0:80
      
      # æ•°æ®åº“è¿æ¥
      - ConnectionStrings__Default=Host=postgres;Port=5432;Database=oneid;Username=oneid;Password=${POSTGRES_PASSWORD:-oneid_prod_password_change_me}
      - Persistence__Provider=Postgres
      - Persistence__ConnectionName=Default
      - Persistence__EnableSensitiveLogging=false  # ç”Ÿäº§ç¯å¢ƒç¦ç”¨æ•æ„Ÿæ•°æ®æ—¥å¿—
      
      # OIDC è®¤è¯é…ç½®
      # Authority: ç”¨äºä¸‹è½½ JWKSï¼ˆä½¿ç”¨å†…éƒ¨åœ°å€é¿å… SSL è¯ä¹¦é—®é¢˜ï¼‰
      - Identity__Authority=http://identity:80
      # ExternalAuthority: JWT Token çš„ Issuerï¼ˆå¤–éƒ¨ HTTPS åœ°å€ï¼‰
      - Identity__ExternalAuthority=https://${DOMAIN}:${IDENTITY_PORT}
      - Identity__RequireHttpsMetadata=false
      
      # Redis é…ç½®
      - Redis__Configuration=redis:6379
      
      # CORS é…ç½®ï¼ˆå…è®¸å‰ç«¯è®¿é—®ï¼‰
      - Cors__AllowedOrigins__0=https://${DOMAIN:-192.168.123.9}:9444
      
      # Data Protection é…ç½® - å…±äº«å¯†é’¥ç›®å½•
      - DataProtection__ApplicationName=${DATAPROTECTION_APP_NAME:-OneID}
      - DataProtection__KeysPath=/app/shared-keys
      
    volumes:
      - dataprotection-keys:/app/shared-keys
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      identity:
        condition: service_healthy
    networks:
      - oneid-network
    restart: unless-stopped
    # å¥åº·æ£€æŸ¥ - ä½¿ç”¨ä¸“ç”¨å¥åº·æ£€æŸ¥ç«¯ç‚¹
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost/api/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s

  # ============================================================
  # Nginx åå‘ä»£ç† (HTTPS)
  # ============================================================
  nginx:
    image: nginx:alpine
    container_name: oneid-nginx
    ports:
      - "${HTTP_PORT:-9080}:80"           # HTTP (è‡ªåŠ¨é‡å®šå‘åˆ° HTTPS)
      - "${IDENTITY_PORT:-9443}:443"      # HTTPS - Identity Server (ç™»å½•ç•Œé¢)
      - "${ADMIN_PORT:-9444}:8443"        # HTTPS - Admin Portal (ç®¡ç†åå°)
    volumes:
      # Nginx é…ç½®æ–‡ä»¶
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      # SSL è¯ä¹¦
      - ./nginx/ssl:/etc/nginx/ssl:ro
      # æ—¥å¿—ï¼ˆå¯é€‰ï¼‰
      - nginx-logs:/var/log/nginx
    depends_on:
      identity:
        condition: service_healthy
      adminapi:
        condition: service_healthy
    networks:
      - oneid-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

# ============================================================
# ç½‘ç»œé…ç½®
# ============================================================
networks:
  oneid-network:
    driver: bridge
    name: oneid-network

# ============================================================
# æ•°æ®å·é…ç½®
# ============================================================
volumes:
  # PostgreSQL æ•°æ®æŒä¹…åŒ–
  postgres-data:
    name: oneid-postgres-data
    
  # Redis æ•°æ®æŒä¹…åŒ–
  redis-data:
    name: oneid-redis-data
    
  # Nginx æ—¥å¿—ï¼ˆå¯é€‰ï¼‰
  nginx-logs:
    name: oneid-nginx-logs
    
  # Data Protection å¯†é’¥å…±äº«å·ï¼ˆIdentity + AdminAPI å…±äº«ï¼‰
  dataprotection-keys:
    name: oneid-dataprotection-keys
