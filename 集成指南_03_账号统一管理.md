# è´¦å·ç»Ÿä¸€ç®¡ç†æŒ‡å—

> æœ¬æ–‡æ¡£ä»‹ç»å¦‚ä½•åœ¨ç°æœ‰ç”¨æˆ·ç³»ç»Ÿä¸ OneID ä¹‹é—´å®ç°è´¦å·ç»Ÿä¸€ç®¡ç†ï¼ŒåŒ…æ‹¬è´¦å·è¿ç§»ã€ç»‘å®šç­–ç•¥å’Œæ··åˆè®¤è¯æ¨¡å¼ã€‚

## ğŸ“‹ ç›®å½•

- [æ¦‚è¿°](#æ¦‚è¿°)
- [ä¸‰ç§è´¦å·ç®¡ç†æ¨¡å¼](#ä¸‰ç§è´¦å·ç®¡ç†æ¨¡å¼)
- [è´¦å·è¿ç§»ç­–ç•¥](#è´¦å·è¿ç§»ç­–ç•¥)
- [å®ç°æ–¹æ¡ˆ](#å®ç°æ–¹æ¡ˆ)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

---

## ğŸ¯ æ¦‚è¿°

### ä¸ºä»€ä¹ˆéœ€è¦è´¦å·ç»Ÿä¸€ç®¡ç†ï¼Ÿ

å½“ä½ çš„åº”ç”¨å·²ç»æœ‰ä¸€å¥—ç”¨æˆ·ç³»ç»Ÿï¼Œä½†å¸Œæœ›å¼•å…¥ OneID è¿›è¡Œç»Ÿä¸€è®¤è¯æ—¶ï¼Œä¼šé¢ä¸´ä»¥ä¸‹é—®é¢˜ï¼š

- ğŸ¤” ç°æœ‰ç”¨æˆ·å¦‚ä½•è¿ç§»åˆ° OneIDï¼Ÿ
- ğŸ¤” ç”¨æˆ·ä½¿ç”¨ç¬¬ä¸‰æ–¹ç™»å½•æ—¶ï¼Œå¦‚ä½•å…³è”åˆ°ç°æœ‰è´¦å·ï¼Ÿ
- ğŸ¤” å¦‚ä½•åŒæ—¶æ”¯æŒæœ¬åœ°è´¦å·å’Œ OneID è´¦å·ç™»å½•ï¼Ÿ
- ğŸ¤” å¦‚ä½•ç¡®ä¿ç”¨æˆ·æ•°æ®çš„ä¸€è‡´æ€§ï¼Ÿ

æœ¬æ–‡æ¡£æä¾›äº†å®Œæ•´çš„è§£å†³æ–¹æ¡ˆã€‚

### æ ¸å¿ƒæ¦‚å¿µ

#### sub (Subject Identifier)

OIDC æ ‡å‡†ä¸­çš„ç”¨æˆ·å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œç”± OneID é¢å‘ã€‚è¿™æ˜¯å…³è”ç”¨æˆ·è´¦å·çš„æ ¸å¿ƒå­—æ®µã€‚

```json
{
  "sub": "550e8400-e29b-41d4-a716-446655440000",
  "email": "user@example.com",
  "name": "å¼ ä¸‰"
}
```

**å…³é”®ç‰¹æ€§**ï¼š
- âœ… å…¨å±€å”¯ä¸€
- âœ… æ°¸ä¸æ”¹å˜
- âœ… å³ä½¿ç”¨æˆ·ä¿®æ”¹é‚®ç®±ã€ç”¨æˆ·åï¼Œ`sub` ä¹Ÿä¸ä¼šå˜

#### è´¦å·å…³è”è¡¨

åœ¨ä½ çš„æ•°æ®åº“ä¸­å»ºç«‹ OneID `sub` ä¸æœ¬åœ°ç”¨æˆ· ID çš„æ˜ å°„å…³ç³»ï¼š

```sql
CREATE TABLE user_identity_mappings (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    local_user_id BIGINT NOT NULL,
    oneid_sub VARCHAR(255) NOT NULL,
    provider VARCHAR(50), -- 'OneID', 'GitHub', 'Google' ç­‰
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    UNIQUE KEY uk_oneid_sub (oneid_sub),
    KEY idx_local_user_id (local_user_id),
    FOREIGN KEY (local_user_id) REFERENCES users(id)
);
```

---

## ğŸ“Š ä¸‰ç§è´¦å·ç®¡ç†æ¨¡å¼

### æ¨¡å¼ 1: å®Œå…¨æ‰˜ç®¡æ¨¡å¼ï¼ˆæ¨èï¼‰

**é€‚ç”¨åœºæ™¯**ï¼šæ–°ç³»ç»Ÿæˆ–å¯ä»¥å®Œå…¨è¿ç§»çš„ç³»ç»Ÿ

**ç‰¹ç‚¹**ï¼š
- æ‰€æœ‰è´¦å·ç”± OneID ç®¡ç†
- æœ¬åœ°ç³»ç»Ÿåªå­˜å‚¨ä¸šåŠ¡æ•°æ®
- ç”¨æˆ·ä¿¡æ¯ä» OneID åŒæ­¥

**æ¶æ„**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ä½ çš„åº”ç”¨      â”‚
â”‚                 â”‚
â”‚  ä¸šåŠ¡æ•°æ®è¡¨     â”‚
â”‚  â”œâ”€ orders      â”‚
â”‚  â”œâ”€ products    â”‚
â”‚  â””â”€ ...         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“ (é€šè¿‡ sub å…³è”)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     OneID       â”‚
â”‚                 â”‚
â”‚  ç”¨æˆ·è´¦å·è¡¨     â”‚
â”‚  â”œâ”€ users       â”‚
â”‚  â”œâ”€ roles       â”‚
â”‚  â””â”€ permissions â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ•°æ®æ¨¡å‹**ï¼š

```typescript
// ä½ çš„åº”ç”¨æ•°æ®åº“
interface Order {
  id: string;
  oneid_sub: string; // å…³è”åˆ° OneID çš„ sub
  product_id: string;
  amount: number;
  created_at: Date;
}

// è·å–ç”¨æˆ·ä¿¡æ¯æ—¶ï¼Œä» OneID è·å–
async function getUserInfo(sub: string) {
  const token = await getAccessToken();
  const response = await fetch('http://localhost:5001/connect/userinfo', {
    headers: { 'Authorization': `Bearer ${token}` }
  });
  return response.json();
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… æ¶æ„æœ€ç®€å•
- âœ… æ•°æ®ä¸€è‡´æ€§æœ€å¥½
- âœ… ç»´æŠ¤æˆæœ¬æœ€ä½

**ç¼ºç‚¹**ï¼š
- âš ï¸ éœ€è¦è¿ç§»ç°æœ‰è´¦å·æ•°æ®

---

### æ¨¡å¼ 2: å…³è”æ¨¡å¼ï¼ˆæ¨èç”¨äºè¿ç§»ï¼‰

**é€‚ç”¨åœºæ™¯**ï¼šå·²æœ‰ç”¨æˆ·ç³»ç»Ÿï¼Œé€æ­¥è¿ç§»åˆ° OneID

**ç‰¹ç‚¹**ï¼š
- ä¿ç•™ç°æœ‰ç”¨æˆ·è¡¨
- OneID `sub` ä¸æœ¬åœ° User ID å»ºç«‹å…³è”
- æ”¯æŒåŒå‘æŸ¥è¯¢

**æ¶æ„**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ä½ çš„åº”ç”¨                â”‚
â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Users   â”‚â—„â”€â”€â–ºâ”‚ Mappings   â”‚ â”‚
â”‚  â”‚         â”‚    â”‚            â”‚ â”‚
â”‚  â”‚ id      â”‚    â”‚local_user  â”‚ â”‚
â”‚  â”‚ email   â”‚    â”‚oneid_sub   â”‚ â”‚
â”‚  â”‚ name    â”‚    â”‚provider    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â†“ (é€šè¿‡ sub å…³è”)
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚   OneID     â”‚
                  â”‚             â”‚
                  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                  â”‚  â”‚ Users  â”‚ â”‚
                  â”‚  â”‚        â”‚ â”‚
                  â”‚  â”‚ sub    â”‚ â”‚
                  â”‚  â”‚ email  â”‚ â”‚
                  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ•°æ®æ¨¡å‹**ï¼š

```typescript
// æœ¬åœ°ç”¨æˆ·è¡¨
interface LocalUser {
  id: number;
  email: string;
  username: string;
  password_hash: string; // ä»ç„¶ä¿ç•™
  created_at: Date;
}

// å…³è”è¡¨
interface UserIdentityMapping {
  id: number;
  local_user_id: number;
  oneid_sub: string;
  provider: 'OneID' | 'GitHub' | 'Google' | 'Gitee';
  created_at: Date;
}

// æŸ¥è¯¢é€»è¾‘
async function getUserByOneIdSub(sub: string): Promise<LocalUser | null> {
  const mapping = await db.query(
    'SELECT local_user_id FROM user_identity_mappings WHERE oneid_sub = ?',
    [sub]
  );
  
  if (!mapping) return null;
  
  return await db.query(
    'SELECT * FROM users WHERE id = ?',
    [mapping.local_user_id]
  );
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… å¹³æ»‘è¿ç§»
- âœ… æ”¯æŒæ··åˆè®¤è¯ï¼ˆæœ¬åœ°å¯†ç  + OneIDï¼‰
- âœ… æ•°æ®éš”ç¦»ï¼Œä¸šåŠ¡ä¸å—å½±å“

**ç¼ºç‚¹**ï¼š
- âš ï¸ éœ€è¦ç»´æŠ¤ä¸¤å¥—ç”¨æˆ·æ•°æ®
- âš ï¸ æ•°æ®åŒæ­¥å¤æ‚åº¦é«˜

---

### æ¨¡å¼ 3: çº¯ SSO æ¨¡å¼

**é€‚ç”¨åœºæ™¯**ï¼šOneID ä»…ç”¨äºè®¤è¯ï¼Œç”¨æˆ·æ•°æ®å®Œå…¨ç”±æœ¬åœ°ç®¡ç†

**ç‰¹ç‚¹**ï¼š
- OneID åªè´Ÿè´£è®¤è¯
- é¦–æ¬¡ç™»å½•æ—¶è‡ªåŠ¨åˆ›å»ºæœ¬åœ°è´¦å·
- æœ¬åœ°ç³»ç»Ÿå®Œå…¨æ§åˆ¶ç”¨æˆ·ä¿¡æ¯

**æ¶æ„**ï¼š

```
ç”¨æˆ·ç™»å½• â†’ OneID è®¤è¯ â†’ è¿”å› Token â†’ æœ¬åœ°ç³»ç»ŸéªŒè¯ Token â†’ åˆ›å»º/æ›´æ–°æœ¬åœ°ç”¨æˆ·
```

**å®ç°**ï¼š

```typescript
// å¤„ç† OneID ç™»å½•å›è°ƒ
async function handleOidcCallback(code: string) {
  // 1. è·å– Token
  const tokenResponse = await exchangeCodeForToken(code);
  
  // 2. è§£æ ID Tokenï¼Œè·å– sub å’ŒåŸºæœ¬ä¿¡æ¯
  const idToken = parseJwt(tokenResponse.id_token);
  const { sub, email, name } = idToken;
  
  // 3. æŸ¥æ‰¾æˆ–åˆ›å»ºæœ¬åœ°ç”¨æˆ·
  let localUser = await findUserBySub(sub);
  
  if (!localUser) {
    // é¦–æ¬¡ç™»å½•ï¼Œåˆ›å»ºæœ¬åœ°è´¦å·
    localUser = await createLocalUser({
      oneid_sub: sub,
      email: email,
      name: name,
    });
    
    console.log('åˆ›å»ºæ–°ç”¨æˆ·:', localUser);
  } else {
    // æ›´æ–°ç”¨æˆ·ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
    await updateUserInfo(localUser.id, { email, name });
  }
  
  // 4. åˆ›å»ºæœ¬åœ°ä¼šè¯
  await createSession(localUser.id);
  
  return localUser;
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… æœ€å¤§çš„çµæ´»æ€§
- âœ… æœ¬åœ°å®Œå…¨æ§åˆ¶ç”¨æˆ·æ•°æ®
- âœ… OneID æ•…éšœä¸å½±å“ç°æœ‰ç”¨æˆ·

**ç¼ºç‚¹**ï¼š
- âš ï¸ éœ€è¦æ‰‹åŠ¨åŒæ­¥ç”¨æˆ·ä¿¡æ¯
- âš ï¸ æ— æ³•ä½¿ç”¨ OneID çš„ç”¨æˆ·ç®¡ç†åŠŸèƒ½

---

## ğŸ”„ è´¦å·è¿ç§»ç­–ç•¥

### ç­–ç•¥ 1: ä¸€æ¬¡æ€§æ‰¹é‡è¿ç§»

**é€‚ç”¨åœºæ™¯**ï¼šç”¨æˆ·é‡ä¸å¤§ï¼ˆ< 10ä¸‡ï¼‰ï¼Œå¯ä»¥è®¡åˆ’åœæœºç»´æŠ¤

**æ­¥éª¤**ï¼š

#### 1. å‡†å¤‡è¿ç§»è„šæœ¬

```typescript
// migrate-users.ts

import { UserManager } from 'oidc-client-ts';
import { db } from './database';

interface LocalUser {
  id: number;
  email: string;
  username: string;
  password_hash: string;
}

async function migrateUsers() {
  console.log('å¼€å§‹è¿ç§»ç”¨æˆ·...');
  
  // 1. è·å–æ‰€æœ‰æœ¬åœ°ç”¨æˆ·
  const localUsers = await db.query<LocalUser[]>('SELECT * FROM users');
  
  console.log(`æ‰¾åˆ° ${localUsers.length} ä¸ªç”¨æˆ·`);
  
  for (const localUser of localUsers) {
    try {
      // 2. åœ¨ OneID ä¸­åˆ›å»ºç”¨æˆ·
      const oneIdUser = await createOneIdUser({
        email: localUser.email,
        username: localUser.username,
        // æ³¨æ„ï¼šå¯†ç éœ€è¦é‡ç½®æˆ–è€…è¦æ±‚ç”¨æˆ·é‡æ–°è®¾ç½®
        requirePasswordReset: true,
      });
      
      // 3. åˆ›å»ºå…³è”è®°å½•
      await db.query(
        'INSERT INTO user_identity_mappings (local_user_id, oneid_sub, provider) VALUES (?, ?, ?)',
        [localUser.id, oneIdUser.sub, 'OneID']
      );
      
      console.log(`âœ“ è¿ç§»æˆåŠŸ: ${localUser.email} -> ${oneIdUser.sub}`);
      
    } catch (error) {
      console.error(`âœ— è¿ç§»å¤±è´¥: ${localUser.email}`, error);
      // è®°å½•å¤±è´¥çš„ç”¨æˆ·ï¼Œç¨åäººå·¥å¤„ç†
      await db.query(
        'INSERT INTO migration_failures (user_id, error) VALUES (?, ?)',
        [localUser.id, error.message]
      );
    }
  }
  
  console.log('è¿ç§»å®Œæˆï¼');
}

// æ‰§è¡Œè¿ç§»
migrateUsers().catch(console.error);
```

#### 2. é€šçŸ¥ç”¨æˆ·

```typescript
// å‘é€é‚®ä»¶é€šçŸ¥
async function notifyUsers() {
  const users = await db.query('SELECT email FROM users');
  
  for (const user of users) {
    await sendEmail({
      to: user.email,
      subject: 'ç³»ç»Ÿå‡çº§é€šçŸ¥ - è¯·é‡ç½®å¯†ç ',
      body: `
        äº²çˆ±çš„ç”¨æˆ·ï¼š
        
        æˆ‘ä»¬å·²å‡çº§åˆ°ç»Ÿä¸€èº«ä»½è®¤è¯ç³»ç»Ÿã€‚
        é¦–æ¬¡ç™»å½•æ—¶ï¼Œè¯·ä½¿ç”¨"å¿˜è®°å¯†ç "åŠŸèƒ½é‡ç½®æ‚¨çš„å¯†ç ã€‚
        
        æ„Ÿè°¢æ‚¨çš„é…åˆï¼
      `,
    });
  }
}
```

---

### ç­–ç•¥ 2: æ¸è¿›å¼è¿ç§»ï¼ˆæ¨èï¼‰

**é€‚ç”¨åœºæ™¯**ï¼šç”¨æˆ·é‡å¤§ï¼Œæ— æ³•åœæœºï¼Œéœ€è¦å¹³æ»‘è¿‡æ¸¡

**åŸç†**ï¼šç”¨æˆ·é¦–æ¬¡ç™»å½•æ—¶è‡ªåŠ¨è¿ç§»

**æ­¥éª¤**ï¼š

#### 1. å®ç°æ··åˆè®¤è¯

```typescript
// auth-service.ts

export async function authenticateUser(username: string, password: string) {
  // 1. å…ˆæ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²è¿ç§»åˆ° OneID
  const mapping = await db.query(
    'SELECT oneid_sub FROM user_identity_mappings m ' +
    'JOIN users u ON m.local_user_id = u.id ' +
    'WHERE u.username = ? OR u.email = ?',
    [username, username]
  );
  
  if (mapping) {
    // å·²è¿ç§»ï¼Œä½¿ç”¨ OneID è®¤è¯
    return await authenticateWithOneId(username, password);
  }
  
  // 2. æœªè¿ç§»ï¼Œä½¿ç”¨æœ¬åœ°è®¤è¯
  const localUser = await authenticateLocal(username, password);
  
  if (!localUser) {
    throw new Error('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯');
  }
  
  // 3. è®¤è¯æˆåŠŸï¼Œè‡ªåŠ¨è¿ç§»åˆ° OneID
  const oneIdUser = await migrateUserToOneId(localUser, password);
  
  console.log(`è‡ªåŠ¨è¿ç§»ç”¨æˆ·: ${localUser.email} -> ${oneIdUser.sub}`);
  
  // 4. åˆ›å»ºå…³è”
  await db.query(
    'INSERT INTO user_identity_mappings (local_user_id, oneid_sub, provider) VALUES (?, ?, ?)',
    [localUser.id, oneIdUser.sub, 'OneID']
  );
  
  // 5. è¿”å› OneID Token
  return await authenticateWithOneId(username, password);
}

// æœ¬åœ°è®¤è¯ï¼ˆæ—§ç³»ç»Ÿï¼‰
async function authenticateLocal(username: string, password: string) {
  const user = await db.query(
    'SELECT * FROM users WHERE username = ? OR email = ?',
    [username, username]
  );
  
  if (!user) return null;
  
  const isValid = await bcrypt.compare(password, user.password_hash);
  return isValid ? user : null;
}

// OneID è®¤è¯
async function authenticateWithOneId(username: string, password: string) {
  const response = await fetch('http://localhost:5001/connect/token', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: new URLSearchParams({
      grant_type: 'password',
      username: username,
      password: password,
      client_id: 'your-client-id',
      client_secret: 'your-client-secret',
      scope: 'openid profile email',
    }),
  });
  
  if (!response.ok) {
    throw new Error('OneID è®¤è¯å¤±è´¥');
  }
  
  return await response.json();
}

// è¿ç§»ç”¨æˆ·åˆ° OneID
async function migrateUserToOneId(localUser: any, password: string) {
  const response = await fetch('http://localhost:5002/api/users', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${ADMIN_TOKEN}`,
    },
    body: JSON.stringify({
      email: localUser.email,
      username: localUser.username,
      password: password, // ä½¿ç”¨åŸå¯†ç 
      name: localUser.name,
    }),
  });
  
  if (!response.ok) {
    throw new Error('è¿ç§»ç”¨æˆ·å¤±è´¥');
  }
  
  return await response.json();
}
```

#### 2. è¿›åº¦ç›‘æ§

```typescript
// è¿ç§»è¿›åº¦ç»Ÿè®¡
async function getMigrationProgress() {
  const totalUsers = await db.query('SELECT COUNT(*) as count FROM users');
  const migratedUsers = await db.query(
    'SELECT COUNT(*) as count FROM user_identity_mappings'
  );
  
  const progress = (migratedUsers.count / totalUsers.count) * 100;
  
  console.log(`è¿ç§»è¿›åº¦: ${progress.toFixed(2)}%`);
  console.log(`å·²è¿ç§»: ${migratedUsers.count} / ${totalUsers.count}`);
  
  return {
    total: totalUsers.count,
    migrated: migratedUsers.count,
    percentage: progress,
  };
}
```

---

### ç­–ç•¥ 3: åŒç³»ç»Ÿå¹¶è¡Œ

**é€‚ç”¨åœºæ™¯**ï¼šéœ€è¦é•¿æœŸå…±å­˜ä¸¤å¥—ç³»ç»Ÿ

**å®ç°**ï¼š

```typescript
// ç™»å½•æ—¶è®©ç”¨æˆ·é€‰æ‹©è®¤è¯æ–¹å¼
export function LoginPage() {
  const [authMode, setAuthMode] = useState<'local' | 'oneid'>('oneid');
  
  return (
    <div>
      <div className="auth-mode-selector">
        <button onClick={() => setAuthMode('local')}>
          ä½¿ç”¨åŸè´¦å·ç™»å½•
        </button>
        <button onClick={() => setAuthMode('oneid')}>
          ä½¿ç”¨ç»Ÿä¸€è´¦å·ç™»å½•
        </button>
      </div>
      
      {authMode === 'local' ? (
        <LocalLoginForm />
      ) : (
        <OneIdLoginForm />
      )}
    </div>
  );
}
```

---

## ğŸ› ï¸ å®ç°æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: é€šè¿‡é‚®ç®±è‡ªåŠ¨ç»‘å®š

**åŸç†**ï¼šç”¨æˆ·ä½¿ç”¨ç¬¬ä¸‰æ–¹ç™»å½•æ—¶ï¼Œå¦‚æœé‚®ç®±åŒ¹é…ï¼Œè‡ªåŠ¨ç»‘å®šåˆ°ç°æœ‰è´¦å·

```typescript
// handle-external-login.ts

async function handleExternalLoginCallback(sub: string, email: string, provider: string) {
  // 1. æ£€æŸ¥æ˜¯å¦å·²æœ‰å…³è”
  let mapping = await db.query(
    'SELECT * FROM user_identity_mappings WHERE oneid_sub = ?',
    [sub]
  );
  
  if (mapping) {
    // å·²å…³è”ï¼Œç›´æ¥ç™»å½•
    return await loginUser(mapping.local_user_id);
  }
  
  // 2. é€šè¿‡é‚®ç®±æŸ¥æ‰¾æœ¬åœ°ç”¨æˆ·
  const localUser = await db.query(
    'SELECT * FROM users WHERE email = ?',
    [email]
  );
  
  if (localUser) {
    // 3. é‚®ç®±åŒ¹é…ï¼Œè‡ªåŠ¨ç»‘å®š
    await db.query(
      'INSERT INTO user_identity_mappings (local_user_id, oneid_sub, provider) VALUES (?, ?, ?)',
      [localUser.id, sub, provider]
    );
    
    console.log(`è‡ªåŠ¨ç»‘å®šè´¦å·: ${email} -> ${provider}`);
    
    // å‘é€é€šçŸ¥
    await sendEmail({
      to: email,
      subject: 'è´¦å·ç»‘å®šé€šçŸ¥',
      body: `æ‚¨çš„è´¦å·å·²æˆåŠŸç»‘å®šåˆ° ${provider}`,
    });
    
    return await loginUser(localUser.id);
  }
  
  // 4. æ–°ç”¨æˆ·ï¼Œåˆ›å»ºè´¦å·
  const newUser = await db.query(
    'INSERT INTO users (email, name) VALUES (?, ?)',
    [email, email.split('@')[0]]
  );
  
  await db.query(
    'INSERT INTO user_identity_mappings (local_user_id, oneid_sub, provider) VALUES (?, ?, ?)',
    [newUser.id, sub, provider]
  );
  
  return await loginUser(newUser.id);
}
```

**å®‰å…¨è€ƒè™‘**ï¼š

```typescript
// é‚®ç®±å¿…é¡»ç»è¿‡éªŒè¯
async function handleExternalLoginCallback(sub: string, email: string, emailVerified: boolean) {
  if (!emailVerified) {
    throw new Error('é‚®ç®±æœªéªŒè¯ï¼Œæ— æ³•è‡ªåŠ¨ç»‘å®š');
  }
  
  // ... å…¶ä»–é€»è¾‘
}
```

---

### æ–¹æ¡ˆ 2: æ‰‹åŠ¨ç»‘å®š

**åŸç†**ï¼šç”¨æˆ·ä¸»åŠ¨åœ¨ä¸ªäººä¸­å¿ƒç»‘å®šç¬¬ä¸‰æ–¹è´¦å·

```typescript
// profile-page.tsx

export function ProfilePage() {
  const [linkedAccounts, setLinkedAccounts] = useState([]);
  
  const handleLinkAccount = async (provider: string) => {
    // 1. å‘èµ·ç»‘å®šæµç¨‹
    sessionStorage.setItem('binding_action', 'link');
    
    // 2. è·³è½¬åˆ° OneID è¿›è¡Œç¬¬ä¸‰æ–¹è®¤è¯
    window.location.href = 
      `http://localhost:5001/api/externalauth/challenge/${provider}?returnUrl=${window.location.origin}/profile/callback`;
  };
  
  return (
    <div>
      <h2>è´¦å·ç»‘å®š</h2>
      <button onClick={() => handleLinkAccount('GitHub')}>
        ç»‘å®š GitHub è´¦å·
      </button>
    </div>
  );
}

// ç»‘å®šå›è°ƒå¤„ç†
async function handleBindingCallback(code: string) {
  const action = sessionStorage.getItem('binding_action');
  
  if (action !== 'link') {
    throw new Error('Invalid binding action');
  }
  
  // 1. è·å– OneID ç”¨æˆ·ä¿¡æ¯
  const tokenResponse = await exchangeCodeForToken(code);
  const idToken = parseJwt(tokenResponse.id_token);
  
  // 2. å…³è”åˆ°å½“å‰ç™»å½•ç”¨æˆ·
  const currentUser = getCurrentUser();
  
  await db.query(
    'INSERT INTO user_identity_mappings (local_user_id, oneid_sub, provider) VALUES (?, ?, ?)',
    [currentUser.id, idToken.sub, idToken.idp]
  );
  
  alert('ç»‘å®šæˆåŠŸï¼');
}
```

---

## âœ… æœ€ä½³å®è·µ

### 1. æ•°æ®ä¸€è‡´æ€§

```typescript
// å®šæœŸåŒæ­¥ç”¨æˆ·ä¿¡æ¯
async function syncUserInfo(userId: number) {
  const mapping = await db.query(
    'SELECT oneid_sub FROM user_identity_mappings WHERE local_user_id = ?',
    [userId]
  );
  
  if (!mapping) return;
  
  // ä» OneID è·å–æœ€æ–°ä¿¡æ¯
  const oneIdUser = await fetchOneIdUser(mapping.oneid_sub);
  
  // æ›´æ–°æœ¬åœ°ç”¨æˆ·ä¿¡æ¯
  await db.query(
    'UPDATE users SET email = ?, name = ?, updated_at = NOW() WHERE id = ?',
    [oneIdUser.email, oneIdUser.name, userId]
  );
}
```

### 2. å¤„ç†é‚®ç®±å†²çª

```typescript
async function handleEmailConflict(newEmail: string, existingUserId: number) {
  // ç­–ç•¥ 1: æ‹’ç»ç»‘å®š
  throw new Error('è¯¥é‚®ç®±å·²è¢«å…¶ä»–è´¦å·ä½¿ç”¨');
  
  // ç­–ç•¥ 2: å‘é€éªŒè¯é‚®ä»¶ï¼Œç”±ç”¨æˆ·ç¡®è®¤åˆå¹¶
  await sendVerificationEmail(newEmail, {
    action: 'merge_account',
    existingUserId,
    newUserId,
  });
}
```

### 3. å®¡è®¡æ—¥å¿—

```typescript
// è®°å½•æ‰€æœ‰è´¦å·å˜æ›´
async function logAccountChange(action: string, userId: number, details: any) {
  await db.query(
    'INSERT INTO account_audit_logs (user_id, action, details, created_at) VALUES (?, ?, ?, NOW())',
    [userId, action, JSON.stringify(details)]
  );
}

// ä½¿ç”¨ç¤ºä¾‹
await logAccountChange('ACCOUNT_LINKED', userId, {
  provider: 'GitHub',
  oneid_sub: sub,
});
```

---

## ğŸ“š ç›¸å…³èµ„æº

- [æ ‡å‡† OIDC é›†æˆ](./é›†æˆæŒ‡å—_01_æ ‡å‡†OIDCé›†æˆ.md)
- [è‡ªå®šä¹‰ç™»å½•é¡µé›†æˆ](./é›†æˆæŒ‡å—_02_è‡ªå®šä¹‰ç™»å½•é¡µé›†æˆ.md)
- [API ç›´æ¥é›†æˆ](./é›†æˆæŒ‡å—_04_APIç›´æ¥é›†æˆ.md)

---

## ğŸ¯ æ€»ç»“

**é€‰æ‹©è´¦å·ç®¡ç†æ¨¡å¼**ï¼š

| åœºæ™¯ | æ¨èæ¨¡å¼ |
|------|---------|
| æ–°ç³»ç»Ÿ | å®Œå…¨æ‰˜ç®¡æ¨¡å¼ |
| ç°æœ‰ç³»ç»Ÿï¼Œç”¨æˆ·é‡ä¸å¤§ | ä¸€æ¬¡æ€§æ‰¹é‡è¿ç§» â†’ å®Œå…¨æ‰˜ç®¡ |
| ç°æœ‰ç³»ç»Ÿï¼Œç”¨æˆ·é‡å¤§ | æ¸è¿›å¼è¿ç§» â†’ å…³è”æ¨¡å¼ |
| éœ€è¦ä¿ç•™æ—§ç³»ç»Ÿ | åŒç³»ç»Ÿå¹¶è¡Œ â†’ å…³è”æ¨¡å¼ |
| OneID ä»…ç”¨äºè®¤è¯ | çº¯ SSO æ¨¡å¼ |

**å…³é”®è¦ç‚¹**ï¼š

1. âœ… ä½¿ç”¨ `sub` ä½œä¸ºå”¯ä¸€æ ‡è¯†
2. âœ… é‚®ç®±å¿…é¡»ç»è¿‡éªŒè¯
3. âœ… è®°å½•è¯¦ç»†çš„å®¡è®¡æ—¥å¿—
4. âœ… æä¾›æ¸…æ™°çš„ç”¨æˆ·é€šçŸ¥
5. âœ… åˆ¶å®šå›æ»šè®¡åˆ’

Happy Integrating! ğŸš€

